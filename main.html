<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduDoc - Notes Selling Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Fonts: Inter (UI text) and Montserrat (Headings) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Montserrat:wght@100..900&display=swap" rel="stylesheet">
    <style>

        /* ==================================== */
        /* 1. Global Theme Variables & Custom CSS */
        /* ==================================== */
        :root {
            --primary: #6366F1; /* Indigo 500 */
            --secondary: #F472B6; /* Pink 400 */
            --tertiary: #FBBF24; /* Amber 400 */
            --backup: #14B8A6; /* Teal 500 */
            --bg-start: #0F172A; /* Slate 900 */
            --bg-end: #1E293B; /* Slate 800 */
            --text-color: #f8fafc;
            --card-bg: #1e293b;
            --card-gradient-start: rgba(30, 41, 59, 0.7);
            --card-gradient-end: rgba(46, 61, 89, 0.7);
            --border-color: rgba(255, 255, 255, 0.05);
            --hover-bg: rgba(107, 114, 128, 0.5);
            --input-bg: #1f2937;
            --input-border: #374151;
            --header-bg: rgba(17, 24, 39, 0.8);
            --radius: 0.75rem;
        }

        /* Light Theme Variables */
        [data-theme="light"] {
            --primary: #4F46E5; /* Indigo 600 */
            --secondary: #EC4899; /* Pink 500 */
            --tertiary: #D97706; /* Amber 600 - Darker for better contrast */
            --backup: #0D9488; /* Teal 600 */
            --bg-start: #F9FAFB; /* Gray 50 */
            --bg-end: #F3F4F6; /* Gray 100 */
            --text-color: #111827; /* Gray 900 */
            --text-secondary: #4B5563; /* Gray 600 */
            --text-tertiary: #6B7280; /* Gray 500 */
            --card-bg: #ffffff;
            --card-gradient-start: rgba(255, 255, 255, 0.95);
            --card-gradient-end: rgba(249, 250, 251, 0.95);
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-bg: rgba(229, 231, 235, 0.7);
            --input-bg: #ffffff;
            --input-border: #D1D5DB;
            --header-bg: rgba(255, 255, 255, 0.95);
            --header-border: rgba(0, 0, 0, 0.1);
            --nav-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding-bottom: 72px; /* Space for fixed bottom nav */
            transition: background 0.3s ease, color 0.3s ease;
        }
        h1, h2, h3, h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-color);
        }
        
        /* Light mode font weight adjustments */
        [data-theme="light"] h1,
        [data-theme="light"] h2,
        [data-theme="light"] h3,
        [data-theme="light"] h4 {
            font-weight: 700;
        }
        
        [data-theme="light"] .font-bold {
            font-weight: 700;
        }
        
        [data-theme="light"] .font-extrabold {
            font-weight: 800;
        }

        /* Custom Utility Classes */
        .card-gradient {
            /* Subtle inner glow and gradient for cards */
            background: linear-gradient(145deg, var(--card-gradient-start), var(--card-gradient-end));
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            color: var(--text-color);
        }
        
        /* Light mode specific styles */
        [data-theme="light"] .card-gradient {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        [data-theme="light"] .text-white {
            color: var(--text-color) !important;
        }
        
        [data-theme="light"] .text-gray-300,
        [data-theme="light"] .text-gray-400 {
            color: var(--text-secondary, #4B5563) !important;
        }
        
        [data-theme="light"] .text-gray-500 {
            color: var(--text-tertiary, #6B7280) !important;
        }
        
        [data-theme="light"] .bg-gray-700,
        [data-theme="light"] .bg-gray-800 {
            background-color: #F3F4F6 !important;
        }
        
        [data-theme="light"] .bg-gray-900 {
            background-color: #E5E7EB !important;
        }
        
        [data-theme="light"] .border-gray-700 {
            border-color: #D1D5DB !important;
        }
        
        [data-theme="light"] input,
        [data-theme="light"] textarea,
        [data-theme="light"] select {
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-color) !important;
        }
        
        [data-theme="light"] input::placeholder,
        [data-theme="light"] textarea::placeholder {
            color: #9CA3AF !important;
        }
        
        /* Fix icon colors in light mode */
        [data-theme="light"] i.fa,
        [data-theme="light"] i.fas,
        [data-theme="light"] i.far,
        [data-theme="light"] i.fab {
            color: inherit;
        }
        
        [data-theme="light"] .text-white i {
            color: var(--text-color) !important;
        }
        
        [data-theme="light"] .text-gray-300 i,
        [data-theme="light"] .text-gray-400 i {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="light"] .text-gray-500 i {
            color: var(--text-tertiary) !important;
        }
        
        /* Navigation icons */
        [data-theme="light"] .nav-item i {
            color: inherit;
        }
        
        /* Specific icon color overrides */
        [data-theme="light"] button i,
        [data-theme="light"] a i {
            color: inherit;
        }
        .card-gradient:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3); /* Primary color shadow */
        }
        .text-gradient {
            /* Apply primary/secondary gradient to headings */
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .btn-primary-gradient {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            transition: all 0.3s ease;
        }
        .btn-primary-gradient:hover {
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.6);
            filter: brightness(1.1);
        }
        .filter-active {
            color: var(--text-color);
            background: var(--primary);
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.5);
        }

        /* Page Transition Animation */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-visible {
            animation: fadeInSlideUp 0.5s ease-out;
        }

        /* NEW: Admin Sidebar Overlay for Mobile */
        .admin-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 45; /* Below header, above main content */
            background: rgba(15, 23, 42, 0.9); /* slate-900/90 */
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .admin-sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .admin-sidebar-content {
            width: 80%; /* Takes 80% of screen width on mobile */
            max-width: 320px;
            height: 100%;
            padding-top: 5rem; /* Space below fixed header */
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            background: var(--bg-end);
        }
        .admin-sidebar-overlay.active .admin-sidebar-content {
            transform: translateX(0);
        }
        /* Desktop/Large screen styles override */
        @media (min-width: 1024px) {
            .admin-sidebar-overlay {
                position: relative;
                opacity: 1;
                pointer-events: auto;
                background: none;
                backdrop-filter: none;
                display: block !important; /* Ensure it appears on desktop grid */
            }
            .admin-sidebar-content {
                width: auto;
                height: auto;
                padding: 0;
                transform: none;
                background: none;
            }
        }
        
        /* Style for the full-screen reader page */
        /* IMPORTANT: Remove body padding when reader is active */
        body.reader-active {
            padding-bottom: 0;
        }
        /* Style for the PDF iframe, ensures full viewport height */
        #reader-iframe {
            width: 100%;
            height: calc(100vh - 60px); /* Full height minus back button bar */
            border: none;
        }
        
        #reading-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60;
            background-color: #0F172A; 
            padding: 0 !important;
            overflow: auto;
        }

        .reader-content {
            padding: 20px 4px;
            max-width: 800px;
            margin: auto;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #d1d5db; /* Light gray text */
        }
        /* Styling for content generated from Markdown */
        .reader-content h2 {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }
        .reader-content h3 {
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--tertiary);
        }
        .reader-content code {
            background-color: rgba(99, 102, 241, 0.1); /* primary/10 */
            padding: 2px 4px;
            border-radius: 4px;
            color: var(--secondary);
            font-family: monospace;
        }
        .reader-content pre {
            background-color: #1e293b; /* slate-800 */
            padding: 1rem;
            overflow-x: auto;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        .reader-content pre code {
            background: none;
            color: #f8fafc;
            padding: 0;
            border-radius: 0;
            font-size: 0.9rem;
        }
        .reader-content strong {
            color: var(--backup);
        }
        
        /* Drag and Drop Styling for File Upload */
        .drag-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        .drag-area.drag-over {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* Authentication Pages Styles */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .biometric-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #6B7280;
            transition: all 0.3s ease;
        }
        .pin-dot.filled {
            background-color: var(--primary);
            border-color: var(--primary);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Tailwind Utility Configuration (Must be included for Tailwind to work) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#F472B6',
                        tertiary: '#FBBF24',
                        backup: '#14B8A6',
                    },
                    borderRadius: {
                        'xl': 'var(--radius)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>


    <!-- ==================================== -->
    <!-- AUTHENTICATION PAGES SECTION -->
    <!-- ==================================== -->
    
    <!-- WELCOME PAGE -->
    <section id="welcome-page" class="page-content hidden antialiased flex items-center justify-center p-4 min-h-screen">
        <div class="max-w-md w-full text-center animate-fade-in">
            <!-- Logo -->
            <div class="mb-8">
                <i class="fas fa-graduation-cap text-6xl text-tertiary mb-4"></i>
                <h1 class="text-5xl font-bold text-gradient mb-2">EduDoc</h1>
                <p class="text-gray-400 text-lg">Your Premium Notes Marketplace</p>
            </div>
            
            <!-- Tagline -->
            <p class="text-gray-300 mb-10 text-base">
                Discover, purchase, and access high-quality educational documents from verified creators.
            </p>
            
            <!-- Action Buttons -->
            <div class="space-y-4">
                <button onclick="showAuthPage('signup')" class="block w-full py-4 rounded-xl btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-105 transition">
                    <i class="fas fa-user-plus mr-2"></i> Create Account
                </button>
                
                <button onclick="showAuthPage('login')" class="block w-full py-4 rounded-xl bg-gray-800/80 backdrop-blur-sm text-white text-lg font-semibold border-2 border-gray-700 hover:border-primary hover:bg-gray-700/80 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
                
                <!-- Skip Button for Prototype -->
                <button onclick="showAuthPage('none')" class="text-gray-500 hover:text-gray-300 text-sm underline mt-6 transition">
                    Skip for Now (Prototype Mode)
                </button>
            </div>
            
            <!-- Footer -->
            <p class="text-gray-600 text-xs mt-12">
                © 2025 EduDoc. Prototype v1.0
            </p>
        </div>
    </section>
    
    <!-- LOGIN PAGE -->
    <section id="login-page" class="page-content hidden antialiased flex items-center justify-center p-4 min-h-screen">
        <div class="max-w-md w-full animate-fade-in">
            <div class="text-center mb-8">
                <button onclick="showAuthPage('welcome')" class="inline-block mb-4">
                    <i class="fas fa-arrow-left text-gray-400 hover:text-white text-lg"></i>
                </button>
                <h1 class="text-4xl font-bold text-gradient mb-2">Welcome Back</h1>
                <p class="text-gray-400">Login to access your account</p>
            </div>
            <form id="login-form" class="card-gradient rounded-xl p-6 shadow-2xl space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                    <input type="email" id="login-email" required
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                           placeholder="john@example.com">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" required
                               class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                               placeholder="••••••••">
                        <button type="button" onclick="toggleAuthPassword('login-password', 'login-password-icon')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="login-password-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember" class="w-4 h-4 text-primary bg-gray-800 border-gray-700 rounded focus:ring-primary">
                        <label for="remember" class="ml-2 text-sm text-gray-400">Remember me</label>
                    </div>
                    <a href="#" class="text-sm text-primary hover:underline">Forgot password?</a>
                </div>
                <button type="submit" class="w-full py-3 rounded-lg btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-105 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login
                </button>
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-700"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-gray-800 text-gray-400">Or continue with</span>
                    </div>
                </div>
                <button type="button" onclick="simulateBiometricAuth()" class="w-full py-3 rounded-lg bg-gray-800 border-2 border-gray-700 text-white hover:border-primary transition">
                    <i class="fas fa-fingerprint mr-2 text-tertiary"></i> Login with Biometrics
                </button>
                <div class="text-center pt-4">
                    <p class="text-gray-400 text-sm">
                        Don't have an account? 
                        <a href="#" onclick="showAuthPage('signup'); return false;" class="text-primary hover:underline font-semibold">Sign Up</a>
                    </p>
                </div>
            </form>
            <div class="text-center mt-6">
                <button onclick="showAuthPage('none')" class="text-gray-500 hover:text-gray-300 text-sm underline transition">
                    Skip for Now (Prototype Mode)
                </button>
            </div>
        </div>
    </section>

    <!-- SIGNUP PAGE -->
    <section id="signup-page" class="page-content hidden antialiased flex items-center justify-center p-4 min-h-screen">
        <div class="max-w-md w-full animate-fade-in">
            <div class="text-center mb-8">
                <button onclick="showAuthPage('welcome')" class="inline-block mb-4">
                    <i class="fas fa-arrow-left text-gray-400 hover:text-white text-lg"></i>
                </button>
                <h1 class="text-4xl font-bold text-gradient mb-2">Create Account</h1>
                <p class="text-gray-400">Join EduDoc and start exploring</p>
            </div>
            <form id="signup-form" class="card-gradient rounded-xl p-6 shadow-2xl space-y-4">
                <div>
                    <label for="signup-fullname" class="block text-sm font-medium text-gray-300 mb-2">Full Name</label>
                    <input type="text" id="signup-fullname" required
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                           placeholder="John Doe">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                    <input type="email" id="signup-email" required
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                           placeholder="john@example.com">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="signup-password" required
                               class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                               placeholder="••••••••">
                        <button type="button" onclick="toggleAuthPassword('signup-password', 'signup-password-icon')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="signup-password-icon"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Minimum 8 characters</p>
                </div>
                <div>
                    <label for="signup-confirm-password" class="block text-sm font-medium text-gray-300 mb-2">Confirm Password</label>
                    <div class="relative">
                        <input type="password" id="signup-confirm-password" required
                               class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-primary focus:border-primary transition"
                               placeholder="••••••••">
                        <button type="button" onclick="toggleAuthPassword('signup-confirm-password', 'signup-confirm-password-icon')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="signup-confirm-password-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-start">
                    <input type="checkbox" id="terms" required class="w-4 h-4 mt-1 text-primary bg-gray-800 border-gray-700 rounded focus:ring-primary">
                    <label for="terms" class="ml-2 text-sm text-gray-400">
                        I agree to the <a href="#" class="text-primary hover:underline">Terms of Service</a> and <a href="#" class="text-primary hover:underline">Privacy Policy</a>
                    </label>
                </div>
                <button type="submit" class="w-full py-3 rounded-lg btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-105 transition">
                    <i class="fas fa-user-plus mr-2"></i> Create Account
                </button>
                <div class="text-center pt-4">
                    <p class="text-gray-400 text-sm">
                        Already have an account? 
                        <a href="#" onclick="showAuthPage('login'); return false;" class="text-primary hover:underline font-semibold">Login</a>
                    </p>
                </div>
            </form>
            <div class="text-center mt-6">
                <button onclick="showAuthPage('none')" class="text-gray-500 hover:text-gray-300 text-sm underline transition">
                    Skip for Now (Prototype Mode)
                </button>
            </div>
        </div>
    </section>

    <!-- PERMISSIONS PAGE -->
    <section id="permissions-page" class="page-content hidden antialiased flex items-center justify-center p-4 min-h-screen">
        <div class="max-w-md w-full animate-fade-in">
            <div class="text-center mb-8">
                <i class="fas fa-shield-alt text-5xl text-tertiary mb-4"></i>
                <h1 class="text-4xl font-bold text-gradient mb-2">App Permissions</h1>
                <p class="text-gray-400">Help us provide you with the best experience</p>
            </div>
            <div class="card-gradient rounded-xl p-6 shadow-2xl space-y-4 mb-6">
                <div class="flex items-start justify-between p-3 rounded-lg hover:bg-gray-700/30 transition">
                    <div class="flex items-start flex-1">
                        <i class="fas fa-folder-open text-2xl text-primary mt-1 mr-4"></i>
                        <div>
                            <h3 class="font-semibold text-white mb-1">Storage Access</h3>
                            <p class="text-xs text-gray-400">Save and manage downloaded documents on your device</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer ml-3">
                        <input type="checkbox" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-start justify-between p-3 rounded-lg hover:bg-gray-700/30 transition">
                    <div class="flex items-start flex-1">
                        <i class="fas fa-bell text-2xl text-secondary mt-1 mr-4"></i>
                        <div>
                            <h3 class="font-semibold text-white mb-1">Notifications</h3>
                            <p class="text-xs text-gray-400">Receive updates about new documents and offers</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer ml-3">
                        <input type="checkbox" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-start justify-between p-3 rounded-lg hover:bg-gray-700/30 transition">
                    <div class="flex items-start flex-1">
                        <i class="fas fa-camera text-2xl text-backup mt-1 mr-4"></i>
                        <div>
                            <h3 class="font-semibold text-white mb-1">Camera Access</h3>
                            <p class="text-xs text-gray-400">Scan QR codes and upload profile pictures</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer ml-3">
                        <input type="checkbox" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-start justify-between p-3 rounded-lg hover:bg-gray-700/30 transition">
                    <div class="flex items-start flex-1">
                        <i class="fas fa-fingerprint text-2xl text-tertiary mt-1 mr-4"></i>
                        <div>
                            <h3 class="font-semibold text-white mb-1">Biometric Authentication</h3>
                            <p class="text-xs text-gray-400">Use fingerprint or face ID for secure login</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer ml-3">
                        <input type="checkbox" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
            </div>
            <div class="mb-6 p-4 rounded-lg bg-gray-800/50 border border-gray-700">
                <p class="text-xs text-gray-400 text-center">
                    <i class="fas fa-lock mr-1"></i> We respect your privacy. You can change these permissions anytime in settings.
                </p>
            </div>
            <div class="space-y-3">
                <button onclick="showAuthPage('lock-unlock')" class="w-full py-3 rounded-lg btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-105 transition">
                    Continue
                </button>
                <button onclick="showAuthPage('none')" class="text-gray-500 hover:text-gray-300 text-sm underline w-full transition">
                    Skip for Now (Prototype Mode)
                </button>
            </div>
        </div>
    </section>

    <!-- LOCK-UNLOCK PAGE -->
    <section id="lock-unlock-page" class="page-content hidden antialiased flex items-center justify-center p-4 min-h-screen">
        <div class="max-w-md w-full animate-fade-in">
            <div class="text-center mb-12">
                <i class="fas fa-graduation-cap text-5xl text-tertiary mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2">EduDoc</h1>
                <p class="text-gray-400 text-sm">Unlock to continue</p>
            </div>
            <div id="biometric-view" class="card-gradient rounded-xl p-8 shadow-2xl text-center">
                <div class="mb-6">
                    <i class="fas fa-fingerprint text-8xl text-tertiary biometric-pulse mb-4"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-2">Touch Sensor to Unlock</h2>
                <p class="text-gray-400 text-sm mb-6">Use your fingerprint or face ID</p>
                <button onclick="unlockWithBiometric()" class="w-full py-3 rounded-lg btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-105 transition mb-4">
                    <i class="fas fa-fingerprint mr-2"></i> Simulate Biometric Unlock
                </button>
                <button onclick="showPasswordUnlockView()" class="text-gray-400 hover:text-white text-sm underline transition">
                    Use Password Instead
                </button>
            </div>
            <div id="password-unlock-view" class="card-gradient rounded-xl p-8 shadow-2xl hidden">
                <div class="text-center mb-6">
                    <i class="fas fa-lock text-5xl text-primary mb-4"></i>
                    <h2 class="text-xl font-bold text-white mb-2">Enter PIN or Password</h2>
                    <p class="text-gray-400 text-sm">Enter your security code</p>
                </div>
                <div id="pin-display" class="flex justify-center gap-3 mb-6">
                    <div class="pin-dot" id="dot-1"></div>
                    <div class="pin-dot" id="dot-2"></div>
                    <div class="pin-dot" id="dot-3"></div>
                    <div class="pin-dot" id="dot-4"></div>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="enterPin('1')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">1</button>
                    <button onclick="enterPin('2')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">2</button>
                    <button onclick="enterPin('3')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">3</button>
                    <button onclick="enterPin('4')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">4</button>
                    <button onclick="enterPin('5')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">5</button>
                    <button onclick="enterPin('6')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">6</button>
                    <button onclick="enterPin('7')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">7</button>
                    <button onclick="enterPin('8')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">8</button>
                    <button onclick="enterPin('9')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">9</button>
                    <button onclick="showBiometricUnlockView()" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-400 text-sm transition">
                        <i class="fas fa-fingerprint"></i>
                    </button>
                    <button onclick="enterPin('0')" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-white text-xl font-semibold transition">0</button>
                    <button onclick="clearPin()" class="p-4 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-400 text-sm transition">
                        <i class="fas fa-backspace"></i>
                    </button>
                </div>
                <p id="error-message" class="text-red-400 text-sm text-center mb-4 hidden">Incorrect PIN. Try again.</p>
            </div>
            <div class="text-center mt-6">
                <button onclick="showAuthPage('none')" class="text-gray-500 hover:text-gray-300 text-sm underline transition">
                    Skip for Now (Prototype Mode)
                </button>
            </div>
        </div>
    </section>

    <!-- ==================================== -->
    <!-- 2. Floating Header (Fixed Top) -->
    <!-- ==================================== -->
    <header id="floating-header" class="fixed top-0 left-0 right-0 z-40 p-4 backdrop-blur-lg shadow-lg" style="background: var(--header-bg); border-bottom: 1px solid var(--header-border, rgba(107, 114, 128, 0.3));">
        <div class="max-w-7xl mx-auto flex justify-between items-center h-12">
            <!-- Logo/Title -->
            <div class="flex items-center space-x-2">
                <i class="fas fa-graduation-cap text-lg text-tertiary"></i>
                <h1 class="text-2xl font-heading font-bold text-gradient">EduDoc</h1>
            </div>
            
            <!-- Actions (Wallet & Search) -->
            <div class="flex items-center space-x-4">
                <!-- Token Wallet -->
                <button onclick="navigate('wallet')" class="flex items-center p-2 rounded-full card-gradient shadow-xl text-sm font-semibold">
                    <i class="fas fa-coins text-tertiary mr-2"></i>
                    <span id="token-wallet-display" class="pr-1">450</span>
                    <i class="fas fa-chevron-right text-xs opacity-75"></i>
                </button>

                <!-- Search Icon -->
                <button onclick="navigate('search')" class="text-xl text-gray-300 hover:text-primary transition">
                    <i class="fas fa-search"></i>
                </button>

                <!-- Profile Avatar -->
                <button onclick="navigate('profile')" class="w-10 h-10 rounded-full bg-primary/70 ring-2 ring-tertiary/50 overflow-hidden shadow-xl hover:ring-tertiary transition">
                    <img id="header-profile-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFFFFF'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" 
                         alt="Profile" class="w-full h-full object-cover">
                </button>
            </div>
        </div>
    </header>


    <!-- ==================================== -->
    <!-- 3. Main Content Area (Page Router) -->
    <!-- ==================================== -->
    <main id="app-container" class="max-w-7xl mx-auto pt-24 p-4 lg:p-6">
        
        <!-- ============================== -->
        <!-- HOME PAGE (Visible by default) -->
        <!-- ============================== -->
        <section id="home-page" class="page-content page-visible">
            <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                Discover
                <span class="text-gradient">Premium Docs</span>
            </h2>

            <!-- Role Switch Card -->
            <div class="mb-6 card-gradient rounded-xl p-4 flex justify-between items-center shadow-lg border-l-4 border-backup/50">
                <p class="text-sm text-gray-300 font-medium">Current Role: <span id="current-role" class="text-tertiary font-bold">Admin</span> (Prototype Switch)</p>
                <button onclick="toggleUserRole()" class="px-3 py-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white text-xs font-semibold transition">
                    Switch to <span id="switch-role-label">User</span>
                </button>
            </div>

            <!-- Offers/Bundles Carousel -->
            <div class="mb-10 overflow-hidden relative rounded-xl shadow-2xl group">
                <div id="offer-carousel" class="flex transition-transform duration-500 ease-in-out">
                    <!-- Carousel Slide 1 -->
                    <div class="min-w-full p-8 bg-gradient-to-br from-primary to-secondary rounded-xl text-white flex flex-col justify-between h-48 sm:h-64">
                        <h3 class="text-2xl sm:text-3xl font-heading font-bold">50% OFF Back-to-School Bundle!</h3>
                        <div class="flex justify-between items-end">
                            <p class="text-sm opacity-90">Math, Science & History. Limited time offer.</p>
                            <button onclick="navigate('offers')" class="bg-white text-primary px-4 py-2 rounded-full font-semibold hover:bg-gray-200 transition">View</button>
                        </div>
                    </div>
                    <!-- Carousel Slide 2 -->
                    <div class="min-w-full p-8 bg-gradient-to-br from-backup to-tertiary rounded-xl text-gray-900 flex flex-col justify-between h-48 sm:h-64">
                        <h3 class="text-2xl sm:text-3xl font-heading font-bold">New Journals Collection</h3>
                        <div class="flex justify-between items-end">
                            <p class="text-sm opacity-90">Start your year with guided wellness and productivity journals.</p>
                            <button onclick="navigate('offers')" class="bg-gray-800 text-white px-4 py-2 rounded-full font-semibold hover:bg-gray-600 transition">Explore</button>
                        </div>
                    </div>
                </div>
                <!-- Carousel Dots Placeholder -->
                <div class="absolute bottom-4 left-0 right-0 flex justify-center space-x-2">
                    <span id="carousel-dot-0" class="w-2.5 h-2.5 rounded-full bg-white opacity-80 transition-all duration-300"></span>
                    <span id="carousel-dot-1" class="w-2.5 h-2.5 rounded-full bg-white opacity-40 transition-all duration-300"></span>
                </div>

                <!-- Navigation Buttons -->
                <button onclick="manualPrevSlide(event)" class="absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-gray-900/50 backdrop-blur-sm rounded-full text-white text-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 hover:bg-gray-900">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="manualNextSlide(event)" class="absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-gray-900/50 backdrop-blur-sm rounded-full text-white text-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 hover:bg-gray-900">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <!-- NEW: My Library Shelf (Downloaded/Purchased) -->
            <div id="library-shelf-wrapper" class="mb-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-heading font-bold text-white">My Library</h3>
                    <button onclick="navigate('library')" class="text-sm font-semibold text-primary hover:text-secondary transition">
                        View All <i class="fas fa-chevron-right text-xs ml-1"></i>
                    </button>
                </div>
                <!-- Scrollable Horizontal List -->
                <div id="home-library-shelf" class="flex space-x-4 overflow-x-auto pb-2">
                    <!-- Library items injected here by renderHomeLibraryShelf() -->
                </div>
            </div>
            <!-- END NEW: My Library Shelf -->


            <!-- Category Filters -->
            <div class="mb-8 flex space-x-3 overflow-x-auto pb-2">
                <button class="filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition active filter-active" data-filter="all">All</button>
                <button class="filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter="Notes">Notes</button>
                <button class="filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter="Books">Books</button>
                <button class="filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter="Journals">Journals</button>
                <button class="filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-primary transition" data-filter="Free"><i class="fas fa-gift mr-1"></i> Free</button>
            </div>

            <!-- Notes/Product Listing -->
            <h3 class="text-2xl font-heading font-bold mb-4 text-white">Popular Listings</h3>
            <div id="product-listing-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Product cards will be injected here by JS -->
            </div>

            <!-- Pagination Container -->
            <div id="pagination-container" class="flex justify-center mt-10 space-x-2">
                <!-- Pagination buttons will be dynamically generated here -->
            </div>
        </section>

        <!-- ================================== -->
        <!-- SEARCH PAGE -->
        <!-- ================================== -->
        <section id="search-page" class="page-content hidden">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-heading font-extrabold mb-6 text-white">
                    Find Your Next 
                    <span class="text-gradient">Document</span>
                </h2>
                
                <!-- Search Input -->
                <div class="relative mb-6">
                    <input type="text" id="search-input" oninput="searchProducts()" placeholder="Search notes, books, or authors..." 
                           class="w-full p-4 pl-12 rounded-xl card-gradient text-white border-none focus:ring-2 focus:ring-primary focus:outline-none placeholder-gray-400 text-lg shadow-xl"
                           autofocus>
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-primary"></i>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-3 mb-8 pb-4 border-b border-gray-700/50">
                    <span class="text-gray-400 text-sm font-semibold mr-2">Category:</span>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition active filter-active" data-filter-type="category" data-filter-value="all">All</button>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter-type="category" data-filter-value="Tech">Tech</button>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter-type="category" data-filter-value="Math">Math</button>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter-type="category" data-filter-value="History">History</button>
                    
                    <span class="text-gray-400 text-sm font-semibold ml-4 mr-2">Price:</span>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition active filter-active" data-filter-type="price" data-filter-value="all">Any Price</button>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter-type="price" data-filter-value="free">Free</button>
                    <button class="search-filter-btn text-sm px-4 py-2 rounded-full shadow-lg border border-gray-700/50 hover:bg-gray-700 transition" data-filter-type="price" data-filter-value="premium">Premium</button>
                </div>
                
                <!-- Search Results -->
                <h3 id="search-results-heading" class="text-xl font-heading font-bold mb-4 text-white">Results (10)</h3>
                <div id="search-results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Results injected here -->
                </div>
            </div>
        </section>

        <!-- ================================== -->
        <!-- PRODUCT DETAILS PAGE -->
        <!-- ================================== -->
        <section id="product-details-page" class="page-content hidden">
            <!-- Content will be dynamically injected here -->
        </section>

        <!-- ================================== -->
        <!-- PROFILE PAGE -->
        <!-- ================================== -->
        <section id="profile-page" class="page-content hidden">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-heading font-extrabold mb-8 text-gradient">My Account</h2>
                
                <!-- Profile Card -->
                <div class="card-gradient rounded-xl p-6 mb-8 flex items-center shadow-2xl">
                    <div class="w-20 h-20 rounded-full bg-primary/70 ring-4 ring-tertiary/50 overflow-hidden flex items-center justify-center">
                        <img id="profile-page-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFFFFF'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" 
                             alt="Profile" class="w-full h-full object-cover">
                    </div>
                    <div class="ml-6">
                        <!-- Dynamic content via JS updateProfileUI() -->
                        <p class="text-2xl font-heading font-bold" id="profile-name-display">Jane Doe</p> 
                        <p class="text-gray-400" id="profile-email-display">jane.doe@edudoc.com</p> 
                       
                    </div>
                    <button class="ml-auto text-primary hover:text-secondary transition text-lg" onclick="openEditProfileModal()">
                        <i class="fas fa-pen"></i>
                    </button>
                </div>

                <!-- Navigation Links -->
                <div class="space-y-4">
                    <!-- Section: Account Management -->
                    <div class="space-y-2 card-gradient rounded-xl p-4 shadow-xl">
                        <h3 class="text-lg font-heading font-bold text-white mb-2">Account Management</h3>
                        <button onclick="navigate('wallet')" class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-coins text-tertiary w-6 mr-3"></i> Token Wallet & History</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                        <button onclick="navigate('bookmarks')" class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-bookmark text-secondary w-6 mr-3"></i> My Bookmarks (<span id="profile-bookmark-count">2</span>)</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                        <!-- UPDATED: Link now navigates to 'activity' page ID -->
                        <button onclick="navigate('activity')" class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-chart-line text-backup w-6 mr-3"></i> My Activity & Purchases</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                         <!-- NEW: Link to separate settings page -->
                        <button onclick="navigate('settings')" class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-cog text-gray-400 w-6 mr-3"></i> App Settings</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                    </div>

                    <!-- Logout Button -->
                    <button onclick="alertCustom('Logout', 'You have been logged out.')" class="w-full py-4 rounded-xl bg-red-700 hover:bg-red-600 text-white text-lg font-bold shadow-2xl transition">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </section>

        <!-- ================================== -->
        <!-- NEW: SETTINGS PAGE -->
        <!-- ================================== -->
        <section id="settings-page" class="page-content hidden">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-heading font-extrabold mb-8 text-gradient">App Settings</h2>

                <div class="space-y-4">
                    <!-- Section: Security & Preferences -->
                    <div class="space-y-2 card-gradient rounded-xl p-4 shadow-xl">
                        <h3 class="text-lg font-heading font-bold text-white mb-2">Security & Preferences</h3>
                        
                        <button onclick="alertCustom('Password Change', 'Change Password flow simulated.')" class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-key text-gray-400 w-6 mr-3"></i> Change Password</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                        
                        <div class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-fingerprint text-gray-400 w-6 mr-3"></i> Biometric Login (Simulated)</span>
                            <!-- Toggle Placeholder -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        
                        <button onclick="alertCustom('Permissions', 'App permissions widget simulated.')" class="w-full flex justify-between items-center py-3 px-3 rounded-lg hover:bg-gray-700/50 transition">
                            <span class="flex items-center"><i class="fas fa-cogs text-gray-400 w-6 mr-3"></i> App Permissions</span>
                            <i class="fas fa-chevron-right text-gray-500"></i>
                        </button>
                    </div>
                    
                    <!-- Section: Appearance -->
                    <div class="space-y-2 card-gradient rounded-xl p-4 shadow-xl">
                        <h3 class="text-lg font-heading font-bold text-white mb-2">Appearance</h3>
                        
                        <div class="w-full flex justify-between items-center py-3 px-3 rounded-lg">
                            <span class="flex items-center"><i class="fas fa-moon text-gray-400 w-6 mr-3"></i> Dark Theme</span>
                            <!-- Theme Toggle Switch -->
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="theme-toggle" class="sr-only peer" onchange="toggleTheme()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                    </div>
                    
                     <!-- Back Button -->
                    <button onclick="navigate('profile')" class="mt-6 w-full py-3 rounded-xl bg-gray-700/50 hover:bg-gray-600 text-white text-lg font-bold shadow-xl transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Profile
                    </button>
                </div>
            </div>
        </section>


        <!-- ================================== -->
        <!-- CART PAGE -->
        <!-- ================================== -->
        <section id="cart-page" class="page-content hidden">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                    <span class="text-gradient">Shopping</span> Cart
                </h2>

                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- Cart Items List (Col 1 & 2) -->
                    <div id="cart-items-container" class="lg:col-span-2 space-y-4">
                        <!-- Cart items injected here -->
                    </div>

                    <!-- Summary Card (Col 3) -->
                    <div class="lg:col-span-1">
                        <div class="card-gradient rounded-xl p-6 sticky top-24 shadow-2xl">
                            <h3 class="text-xl font-heading font-bold mb-4 text-primary border-b border-gray-700/50 pb-3">Order Summary</h3>
                            
                            <div class="space-y-3 text-sm mb-6">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Items (<span id="summary-item-count">0</span>)</span>
                                    <span id="summary-subtotal" class="font-medium text-white">0 Tokens</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Tax/Fees (Simulated)</span>
                                    <span class="font-medium text-white">0 Tokens</span>
                                </div>
                            </div>

                            <div class="flex justify-between font-bold text-lg mb-6 pt-3 border-t border-gray-700/50">
                                <span>Total Tokens Required</span>
                                <span id="summary-total-cost" class="text-tertiary">0 Tokens</span>
                            </div>

                            <button id="checkout-btn" onclick="checkout()" class="w-full py-3 rounded-lg btn-primary-gradient text-white text-lg font-bold shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-wallet mr-2"></i> Proceed to Checkout
                            </button>
                            <p id="checkout-status" class="text-sm mt-3 text-center text-red-400 hidden">Insufficient tokens. Please buy more.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================================== -->
        <!-- WALLET PAGE -->
        <!-- ================================== -->
        <section id="wallet-page" class="page-content hidden">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                    Your <span class="text-gradient">Token Wallet</span>
                </h2>

                <!-- Current Balance Card -->
                <div class="card-gradient rounded-xl p-8 mb-8 flex flex-col sm:flex-row justify-between items-center shadow-2xl bg-gradient-to-tr from-gray-800/80 to-primary/20">
                    <div>
                        <p class="text-sm font-semibold text-gray-400 mb-1">Current Token Balance</p>
                        <h1 class="text-6xl font-heading font-extrabold text-tertiary flex items-center">
                            <i class="fas fa-coins text-4xl mr-3"></i>
                            <span id="wallet-balance-display">450</span>
                        </h1>
                        <p class="text-sm text-gray-500 mt-2">Value managed by secure ledger (Mock)</p>
                    </div>
                    <button onclick="openBuyTokensModal()" class="mt-6 sm:mt-0 px-6 py-3 rounded-full btn-primary-gradient text-white text-lg font-bold shadow-xl hover:scale-105 transition">
                        <i class="fas fa-plus mr-2"></i> Buy Tokens
                    </button>
                </div>

                <!-- Transaction History -->
                <h3 class="text-2xl font-heading font-bold mb-4 text-white">Transaction History</h3>
                <div id="transaction-history-container" class="space-y-3">
                    <!-- Transactions injected here -->
                </div>
                
                <p class="text-center text-gray-500 mt-6 text-sm">End of history.</p>
            </div>
        </section>

        <!-- ================================== -->
        <!-- BOOKMARKS PAGE -->
        <!-- ================================== -->
        <section id="bookmarks-page" class="page-content hidden">
             <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                    My <span class="text-gradient">Saved Documents</span>
                </h2>

                <div id="bookmarks-list-container" class="grid grid-cols-1 gap-6">
                    <!-- Bookmarked product cards injected here -->
                </div>

                <p id="bookmarks-empty-message" class="col-span-full text-center text-gray-400 p-8 card-gradient rounded-xl hidden mt-6">
                    You haven't bookmarked any documents yet. Start exploring the Home page!
                </p>
            </div>
        </section>
        
        <!-- ================================== -->
        <!-- NEW: LIBRARY PAGE (All Owned Content) -->
        <!-- ================================== -->
        <section id="library-page" class="page-content hidden">
            <!-- Content dynamically generated by renderLibraryPage() -->
        </section>


        <!-- ================================== -->
        <!-- OFFERS/PLANS/BUNDLES PAGE -->
        <!-- ================================== -->
        <section id="offers-page" class="page-content hidden">
            <!-- Content dynamically generated by renderOffersPage() -->
        </section>

        <!-- ================================== -->
        <!-- NEW: OFFER DETAILS PAGE -->
        <!-- ================================== -->
        <section id="offer-details-page" class="page-content hidden">
             <!-- Content dynamically generated by renderOfferDetails() -->
        </section>


        <!-- ================================== -->
        <!-- READING PAGE (E-Reader Simulation) -->
        <!-- ================================== -->
        <section id="reading-page" class="page-content hidden">
            <!-- Content dynamically generated by openReader() -->
        </section>

        <!-- ================================== -->
        <!-- USER ACTIVITY PAGE -->
        <!-- ================================== -->
        <section id="user-activity-page" class="page-content hidden">
            <!-- Content dynamically generated by renderUserActivityPage() -->
        </section>


        <!-- ======================================= -->
        <!-- ADMIN DASHBOARD (Used for Admin Activity) -->
        <!-- ======================================= -->
        <section id="admin-dashboard-page" class="page-content hidden">
            
            <div class="flex justify-between items-center lg:block">
                <h2 class="text-2xl font-heading font-extrabold text-white mb-6">
                    Admin <span class="text-gradient">Dashboard</span>
                </h2>
                <!-- NEW: Mobile Menu Toggle Button -->
                <button onclick="toggleAdminSidebar()" class="lg:hidden px-4 py-2 rounded-lg bg-gray-700 text-white font-semibold mb-6">
                    <i class="fas fa-bars mr-2"></i> Menu
                </button>
            </div>
            
            <div class="lg:grid lg:grid-cols-12 gap-6 relative">
                
                <!-- NEW: Admin Sidebar Overlay (Mobile) -->
                <div id="admin-sidebar-overlay" class="admin-sidebar-overlay lg:col-span-3">
                    <div class="admin-sidebar-content card-gradient shadow-2xl lg:p-0 lg:rounded-none lg:static lg:h-fit">
                        
                        <div class="lg:sticky lg:top-24 p-4 space-y-3 h-full lg:h-fit">
                            <div class="flex justify-between items-center mb-3 border-b border-gray-700/50 pb-2">
                                <h3 class="text-lg font-heading font-bold text-primary">Navigation</h3>
                                <button onclick="toggleAdminSidebar()" class="lg:hidden text-gray-400 hover:text-red-400 text-xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Admin Navigation Links -->
                            <button onclick="renderAdminSection('dashboard')" class="admin-nav-item w-full flex items-center p-3 rounded-lg bg-primary/20 text-white hover:bg-primary/40 transition active-admin-nav">
                                <i class="fas fa-tachometer-alt w-6 mr-3"></i> Dashboard Overview
                            </button>
                            <button onclick="renderAdminSection('products')" class="admin-nav-item w-full flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700/50 transition">
                                <i class="fas fa-box w-6 mr-3"></i> Product Management
                            </button>
                            <button onclick="renderAdminSection('sales')" class="admin-nav-item w-full flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700/50 transition">
                                <i class="fas fa-chart-bar w-6 mr-3"></i> Sales Report
                            </button>
                            <button onclick="renderAdminSection('users')" class="admin-nav-item w-full flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700/50 transition">
                                <i class="fas fa-users w-6 mr-3"></i> User Management
                            </button>
                            <button onclick="renderAdminSection('offers')" class="admin-nav-item w-full flex items-center p-3 rounded-lg text-gray-300 hover:bg-gray-700/50 transition">
                                <i class="fas fa-tags w-6 mr-3"></i> Offer Management
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Content (Col 4-12) -->
                <div id="admin-content" class="lg:col-span-9 space-y-6">
                    <!-- Default Dashboard Content (Injected by renderAdminSection) -->
                    <!-- This content will be dynamically updated by JavaScript -->
                </div>
            </div>
        </section>
        
        <!-- Placeholder for Product Management Page Content -->
        <section id="admin-products-page" class="page-content hidden">
            <!-- Content will be dynamically generated by renderAdminSection('products') -->
        </section>
        
        <!-- Placeholder for Add/Edit Product Form Page Content -->
        <section id="admin-product-form-page" class="page-content hidden">
            <!-- Content will be dynamically generated by renderProductForm() -->
        </section>

        <!-- Placeholder for Offer Form Page Content -->
        <section id="admin-offer-form-page" class="page-content hidden">
            <!-- Content will be dynamically generated by renderOfferForm() -->
        </section>


        <!-- Placeholder for Sales Report Page Content -->
        <section id="admin-sales-page" class="page-content hidden">
            <!-- Content will be dynamically generated by renderAdminSection('sales') -->
        </section>
        
        <!-- Placeholder for User Management Page Content -->
        <section id="admin-users-page" class="page-content hidden">
            <!-- Content will be dynamically generated by renderAdminSection('users') -->
        </section>
        
        <!-- Placeholder for Offer Management Page Content -->
        <section id="admin-offers-page" class="page-content hidden">
            <!-- Content will be dynamically generated by renderAdminSection('offers') -->
        </section>
        
    </main>


    <!-- ==================================== -->
    <!-- 4. Fixed Bottom Navigation Bar -->
    <!-- ==================================== -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 z-50 backdrop-blur-lg shadow-2xl" style="background: var(--nav-bg, rgba(17, 24, 39, 0.9)); border-top: 1px solid var(--header-border, rgba(107, 114, 128, 0.3));">
        <div class="max-w-xl mx-auto h-16 flex justify-around items-center">
            <!-- Home -->
            <button onclick="navigate('home')" class="nav-item flex flex-col items-center text-xs font-semibold text-primary">
                <i class="fas fa-home text-xl mb-1"></i>
                <span>Home</span>
            </button>
            <!-- Cart -->
            <button onclick="navigate('cart')" class="nav-item relative flex flex-col items-center text-xs font-semibold text-gray-400 hover:text-primary transition">
                <i class="fas fa-shopping-cart text-xl mb-1"></i>
                <span>Cart</span>
                <span id="cart-count" class="absolute top-0 right-0 -mt-1 -mr-2 w-5 h-5 flex items-center justify-center text-xs bg-red-500 rounded-full">2</span>
            </button>
            <!-- My Activity (Now Admin Dashboard for Admin/Tutor user) -->
            <!-- UPDATED: Navigates to 'activity' -->
            <button onclick="navigate('activity')" class="nav-item flex flex-col items-center text-xs font-semibold text-gray-400 hover:text-primary transition">
                <i class="fas fa-chart-line text-xl mb-1"></i>
                <span>Activity</span>
            </button>
            <!-- Settings -->
            <button onclick="navigate('settings')" class="nav-item flex flex-col items-center text-xs font-semibold text-gray-400 hover:text-primary transition">
                <i class="fas fa-cog text-xl mb-1"></i>
                <span>Settings</span>
            </button>
             <!-- My Account (MOVED TO EXTREME RIGHT) -->
            <button onclick="navigate('profile')" class="nav-item flex flex-col items-center text-xs font-semibold text-gray-400 hover:text-primary transition">
                <i class="fas fa-user-circle text-xl mb-1"></i>
                <span>Account</span>
            </button>
        </div>
    </nav>
    
    <!-- ==================================== -->
    <!-- 6. Modal: Edit Profile -->
    <!-- ==================================== -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="card-gradient rounded-xl p-8 w-full max-w-md mx-4 transform scale-95 transition-transform duration-300 shadow-2xl">
            <h3 class="text-2xl font-heading font-bold text-gradient mb-6">Edit Profile Information</h3>

            <form id="edit-profile-form" onsubmit="handleProfileUpdate(event)">
                <!-- Profile Picture Picker -->
                <div class="mb-6 flex flex-col items-center">
                    <label class="block text-sm font-medium text-gray-400 mb-3">Profile Picture</label>
                    <div class="relative w-24 h-24 rounded-full bg-gray-800 border-2 border-gray-700 overflow-hidden group mb-2">
                        <img id="profile-image-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236B7280'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" 
                             alt="Profile" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-camera text-white text-xl"></i>
                        </div>
                    </div>
                    <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="handleProfileImageSelect(event)">
                    <button type="button" onclick="document.getElementById('profile-picture-input').click()" 
                            class="text-sm text-primary hover:text-secondary transition">
                        Change Picture
                    </button>
                </div>
                
                <div class="mb-4">
                    <label for="edit-name" class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                    <input type="text" id="edit-name" required
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition"
                           placeholder="Enter your new name">
                </div>
                <div class="mb-6">
                    <label for="edit-email" class="block text-sm font-medium text-gray-400 mb-2">Email Address</label>
                    <input type="email" id="edit-email" required
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition"
                           placeholder="Enter your new email">
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeEditProfileModal()" 
                            class="px-5 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                        Cancel
                    </button>
                    <button type="submit" class="px-5 py-2 rounded-lg btn-primary-gradient text-white font-semibold">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================================== -->
    <!-- 7. Modal: Buy Tokens -->
    <!-- ==================================== -->
    <div id="buy-tokens-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="card-gradient rounded-xl p-8 w-full max-w-xl mx-4 transform scale-95 transition-transform duration-300 shadow-2xl">
            <h3 class="text-2xl font-heading font-bold text-gradient mb-6">Purchase Tokens</h3>

            <div class="grid grid-cols-2 gap-4">
                <!-- Package 1 -->
                <div class="p-4 rounded-xl border-2 border-primary/50 text-center hover:bg-gray-700/50 cursor-pointer transition" onclick="buyTokens(100)">
                    <p class="text-3xl font-heading font-extrabold text-tertiary">100</p>
                    <p class="text-sm text-gray-400 mb-2">Tokens</p>
                    <p class="font-bold text-primary">$1.00 USD (Mock)</p>
                </div>
                <!-- Package 2 (Best Value) -->
                <div class="p-4 rounded-xl border-2 border-secondary text-center bg-secondary/10 hover:bg-secondary/20 cursor-pointer transition relative" onclick="buyTokens(500)">
                    <span class="absolute top-0 right-0 -mt-3 -mr-3 px-3 py-1 bg-red-600 text-xs font-bold rounded-full transform rotate-3 shadow-lg">BEST VALUE</span>
                    <p class="text-3xl font-heading font-extrabold text-secondary">500</p>
                    <p class="text-sm text-gray-400 mb-2">Tokens</p>
                    <p class="font-bold text-secondary">$4.50 USD (Mock)</p>
                </div>
                <!-- Package 3 -->
                <div class="p-4 rounded-xl border-2 border-primary/50 text-center hover:bg-gray-700/50 cursor-pointer transition" onclick="buyTokens(1000)">
                    <p class="text-3xl font-heading font-extrabold text-tertiary">1000</p>
                    <p class="text-sm text-gray-400 mb-2">Tokens</p>
                    <p class="font-bold text-primary">$9.00 USD (Mock)</p>
                </div>
                 <!-- Package 4 -->
                <div class="p-4 rounded-xl border-2 border-primary/50 text-center hover:bg-gray-700/50 cursor-pointer transition" onclick="buyTokens(2500)">
                    <p class="text-3xl font-heading font-extrabold text-tertiary">2500</p>
                    <p class="text-sm text-gray-400 mb-2">Tokens</p>
                    <p class="font-bold text-primary">$20.00 USD (Mock)</p>
                </div>
            </div>

            <button type="button" onclick="closeBuyTokensModal()" 
                    class="mt-6 w-full py-3 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                Cancel
            </button>
        </div>
</div>

    <!-- ==================================== -->
    <!-- 8. Purchase Confirmation Modal -->
    <!-- ==================================== -->
    <div id="purchase-confirm-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="card-gradient rounded-xl p-8 w-full max-w-xl mx-4 transform scale-95 transition-transform duration-300 shadow-2xl">
            <h3 class="text-2xl font-heading font-bold text-gradient mb-4">Confirm Purchase</h3>
            <p class="text-gray-300 mb-6" id="purchase-confirm-text">Are you sure you want to purchase this item?</p>
            
            <div class="flex space-x-4">
                <button type="button" id="confirm-purchase-btn" 
                    class="flex-1 py-3 rounded-xl btn-primary-gradient text-white font-bold hover:opacity-90 transition">
                    Confirm Purchase
                </button>
                <button type="button" onclick="closePurchaseConfirmModal()"
                    class="flex-1 py-3 rounded-xl border border-gray-600 text-gray-400 hover:bg-gray-700 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- ==================================== -->
    <!-- 5. JavaScript Logic -->
    <!-- ==================================== -->
    <script>
        // Dummy Data & State Management
        const DUMMY_PRODUCTS = [
            { id: 1, type: 'Notes', title: 'Calculus I - Integrals', description: 'Comprehensive notes covering definite and indefinite integrals. Includes solved practice problems and key theorems.', price: 50, isFree: false, category: 'Math', tags: ['High-Demand', 'STEM'], rating: 4.8, author: 'Dr. Emily Carter', pages: 45, reviewCount: 88, details: 'This document provides an in-depth, semester-long guide to Calculus I, focusing heavily on integration techniques, substitution, and fundamental theorem applications. Essential for university students.', content: '## Chapter 1: The Antiderivative\n\nThe fundamental concept of integral calculus is the **antiderivative**, or the reverse operation of differentiation. If the derivative of $F(x)$ is $f(x)$, then $F(x)$ is the antiderivative of $f(x)$. We denote this relationship using the indefinite integral symbol: $\\int f(x) dx = F(x) + C$, where $C$ is the constant of integration.\n\n### Fundamental Theorem of Calculus\n\nThis theorem is the cornerstone that links differentiation and integration. It states that if $f$ is continuous on $[a, b]$ and $F$ is an antiderivative of $f$, then the definite integral is calculated as:\n\n$$\\int_{a}^{b} f(x) dx = F(b) - F(a)$$ \n\nThis allows us to easily compute the area under a curve without using the limit definition of the Riemann sum.\n\n## Chapter 2: Integration Techniques\n\nEffective integration often relies on algebraic manipulation and pattern recognition. The most common technique is **substitution** ($u$-substitution), which simplifies complex functions by replacing a part of the integrand with a new variable $u$, effectively reversing the chain rule.\n\n### Practice Problem 1\n\nCalculate the indefinite integral: $\\int x(x^2 + 1)^3 dx$. (Solution: Let $u = x^2 + 1$. Then $du = 2x dx$. We rewrite the integral as $\\frac{1}{2} \\int u^3 du$. The solution is $\\frac{1}{8}(x^2+1)^4 + C$.)', pdfUrl: 'https://cdn.jsdelivr.net/gh/mozilla/pdf.js/examples/learning/helloworld.pdf' },
            { id: 2, type: 'Books', title: 'Historical Atlas: WW2', description: 'Digital atlas with interactive maps and timelines. Explore global conflicts from 1939-1945.', price: 120, isFree: false, category: 'History', tags: ['Premium', 'New'], rating: 4.5, author: 'Prof. David Lee', pages: 300, reviewCount: 42, details: 'A rich, multimedia-ready eBook detailing the major events, political dynamics, and geographical shifts of World War II. Perfect for advanced high school and college history courses.', content: '## Prelude to War\n\nThe 1930s saw the rapid rise of totalitarian regimes in Germany, Italy, and Japan, driven by aggressive expansionist ideologies and dissatisfaction with the post-WWI territorial settlements. The failure of the League of Nations to enforce collective security set the stage for a new global conflict.\n\n### The Eastern Front\n\nBeginning with Operation Barbarossa in 1941, the Eastern Front was the largest and bloodiest theater of World War II. The battle for Stalingrad (1942-1943) is widely considered the turning point, halting the German advance and forcing the Wehrmacht into a protracted and costly retreat.' },
            { id: 3, type: 'Journals', title: 'Daily Gratitude Prompts', description: 'A 30-day journal template for mindfulness and productivity.', price: 0, isFree: true, category: 'Wellness', tags: ['Free', 'Popular'], rating: 4.9, author: 'Wellness Hub', pages: 30, reviewCount: 150, details: 'Start your day right with guided prompts designed to improve mental clarity, reduce stress, and foster a positive mindset. Downloadable PDF and interactive digital journal included.', content: '## Day 1: Grounding\n\n**Morning Prompt:** List three sensory details you notice right now (a smell, a sound, a sight). How do these details anchor you in the present moment?\n\n**Evening Reflection:** What is one small success you achieved today, even if it was just completing a task? What positive words can you use to describe your effort?' },
            { id: 4, type: 'Notes', title: 'React Hooks Deep Dive', description: 'Advanced guide to custom hooks, state management, and performance optimization.', price: 75, isFree: false, category: 'Tech', tags: ['Coding', 'Advanced'], rating: 4.7, author: 'Code Master', pages: 62, reviewCount: 71, details: 'For developers who already know React basics. This note set covers useState, useEffect dependency array pitfalls, useMemo, useCallback, and creating reusable custom hooks for enterprise applications.', content: '## Custom Hooks: Reusability\n\nCustom hooks are JavaScript functions that start with `use` and can call other hooks. Their main purpose is to share stateful logic between components without sharing the components themselves.\n\n```javascript\n// Simple custom hook to manage boolean state\nconst useToggle = (initialState = false) => {\n  const [state, setState] = useState(initialState);\n  const toggle = useCallback(() => {\n    setState(prev => !prev);\n  }, []);\n  return [state, toggle];\n};\n```\n\n### The Rules of Hooks\n\n1. Only call Hooks at the top level of your function components.\n2. Only call Hooks from React Function components or Custom Hooks.' },
            { id: 5, type: 'Notes', title: 'Intro to Microeconomics', description: 'Key concepts of supply, demand, market equilibrium, and basic economic models.', price: 40, isFree: false, category: 'Economics', tags: ['Beginner'], rating: 4.2, author: 'The Econ Tutor', pages: 35, reviewCount: 20, details: 'A clearly articulated introduction to core Microeconomics principles. Designed to supplement introductory college lectures, featuring detailed graphs and easy-to-understand examples.', content: '## The Law of Demand\n\nThe law of demand states that, all else being equal (ceteris paribus), as the price of a good or service increases, the quantity demanded decreases, and vice versa. This inverse relationship is fundamental to market analysis.' },
            { id: 6, type: 'Books', title: 'The Art of Minimalist Design', description: 'Principles and case studies of modern minimalistic design and its impact on user experience.', price: 150, isFree: false, category: 'Design', tags: ['Aesthetics'], rating: 5.0, author: 'Clara Vane', pages: 200, reviewCount: 105, details: 'An inspiring book exploring how less can be more in digital and physical design. Features interviews with leading designers and practical tips for applying minimalism to interfaces.', content: '## Principle 3: Intentional White Space\n\nWhite space (or negative space) is not merely empty area; it is a critical design element that enhances readability and visual hierarchy. By intentionally leaving space, you guide the user\'s eye to the elements that matter most.' },
            { id: 7, type: 'Journals', title: 'Data Structures & Algorithms', description: 'Detailed notes on Trees, Graphs, and Heaps for interview preparation.', price: 90, isFree: false, category: 'Tech', tags: ['Coding', 'Algorithms'], rating: 4.6, author: 'Code Master', pages: 75, reviewCount: 55, details: 'A rigorous set of notes focused on preparing for technical interviews. Includes complexity analysis, common interview questions, and detailed diagrams for various data structures.', content: '## Binary Search Trees (BST)\n\nA binary search tree is a node-based binary tree data structure with the property that the left subtree of any node contains only nodes with keys less than the node\'s key, and the right subtree contains only nodes with keys greater than the node\'s key.' },
            { id: 8, type: 'Notes', title: 'The Solar System Explained', description: 'Notes on planetary science, basic astrophyics, and space exploration.', price: 0, isFree: true, category: 'Science', tags: ['Free', 'Space'], rating: 4.9, author: 'AstroKid', pages: 20, reviewCount: 95, details: 'A fun and fact-filled summary of our solar system, perfect for middle school students or anyone interested in astronomy. Includes high-resolution mock imagery.', content: '## The Inner Planets\n\nMercury, Venus, Earth, and Mars are the four inner, terrestrial planets. They are primarily composed of silicate rocks and metals. Venus, despite being farther from the Sun than Mercury, is the hottest planet in our system due to its dense, $\\text{CO}_2$ atmosphere causing a runaway greenhouse effect.' },
            { id: 9, type: 'Notes', title: 'Physics 101: Motion', description: 'Notes covering Kinematics, forces, and Newtonian mechanics.', price: 60, isFree: false, category: 'Science', tags: ['STEM'], rating: 4.4, author: 'Dr. Emily Carter', pages: 50, reviewCount: 30, details: 'First-year university physics notes, simplifying complex concepts like vector decomposition and kinetic energy. High-quality diagrams throughout.', content: '## Newton\'s Second Law\n\nThe acceleration of an object is dependent upon two variables: the net force acting upon the object and the mass of the object. This relationship is expressed by the formula: $F_{\\text{net}} = m \\cdot a$.' },
            { id: 10, type: 'Books', title: 'The French Revolution', description: 'A concise history of the French Revolution, covering key figures and events.', price: 110, isFree: false, category: 'History', tags: ['Classic'], rating: 4.3, author: 'Prof. David Lee', pages: 250, reviewCount: 15, details: 'In-depth analysis of the causes, course, and consequences of the French Revolution. Suitable for college-level reading.', content: '## The Reign of Terror\n\nSpanning from September 1793 to July 1794, the Reign of Terror was a period of the French Revolution when political massacres and numerous public executions took place in response to revolutionary fervor, anticlerical sentiment, and accusations of treason.' },
        ];
        
        let userWalletTokens = 450;
        let bookmarkedProductIds = [1, 6]; // Changed bookmark ID to include product 1 for PDF demo
        let cartItems = [DUMMY_PRODUCTS[0], DUMMY_PRODUCTS[4]]; // Start with two items in cart
        let currentFilter = 'all';
        
        // Mock Transaction History
        const TRANSACTION_HISTORY = [
            { id: 101, type: 'Credit', amount: 500, date: '2025-08-01', description: 'Package purchase (Mock)' },
            { id: 102, type: 'Debit', amount: 50, date: '2025-08-05', description: 'Purchased Calculus I - Integrals' },
            { id: 103, type: 'Debit', amount: 40, date: '2025-08-10', description: 'Purchased Intro to Microeconomics' },
            { id: 104, type: 'Debit', amount: 120, date: '2025-08-12', description: 'Purchased Historical Atlas: WW2' },
            { id: 105, type: 'Download', amount: 0, date: '2025-08-15', description: 'Downloaded Daily Gratitude Prompts' },
        ];

        // User Data for Profile Editing
        let currentUser = {
            name: 'Jane Doe',
            email: 'jane.doe@edudoc.com',
            status: 'Active'
        };
        
        // NEW: Role Status for Conditional Content - Now mutable
        let userRole = 'Admin'; // Default role

        // NEW: Offer Mock Data
        let DUMMY_OFFERS = [
            { id: 201, title: 'Back-to-School Bundle', discount: '50%', duration: '30 Days', status: 'Active', productIds: [1, 2, 4], tokenPrice: 200 },
            { id: 202, title: 'All Tech Docs Pack', discount: '20%', duration: 'Permanent', status: 'Active', productIds: [4, 7], tokenPrice: 130 },
            { id: 203, title: 'Wellness Starter Kit', discount: 'Free Item', duration: 'Expired', status: 'Inactive', productIds: [3], tokenPrice: 0 },
        ];


        
        // NEW: Admin Mock Data
        const DUMMY_ADMIN_METRICS = {
            totalTokensSold: 12500,
            totalDownloads: 4850,
            activeUsers: 950,
            productCount: DUMMY_PRODUCTS.length,
        };
        
        const DUMMY_ADMIN_ACTIVITY = [
            { type: 'Product Updated', description: 'Calculus I notes price updated.', date: '2025-08-22 10:30' },
            { type: 'User Sign-Up', description: 'New user "Liam K." registered.', date: '2025-08-22 09:15' },
            { type: 'Offer Created', description: '50% Off Bundle offer launched.', date: '2025-08-21 14:00' },
            { type: 'Sale', description: '50 tokens purchased by user usr-001.', date: '2025-08-21 11:00' },
        ];
        
        const DUMMY_USERS = [
            { id: 'usr-001', name: 'Jane Doe', email: 'jane@doc.com', status: 'Active', role: 'User', tokens: 450, lastLogin: '2025-08-20' },
            { id: 'usr-002', name: 'Alex M.', email: 'alex@doc.com', status: 'Inactive', role: 'User', tokens: 10, lastLogin: '2025-07-15' },
            { id: 'usr-003', name: 'Tutor Admin', email: 'admin@doc.com', status: 'Active', role: 'Admin', tokens: 99999, lastLogin: '2025-08-22' },
        ];


        // === PAGINATION STATE ===
        let currentPage = 1; 
        const ITEMS_PER_PAGE = 6; 
        // ========================

        // Search State
        let currentSearchTerm = '';
        let currentSearchCategory = 'all';
        let currentSearchPrice = 'all';
        
        // Store previous page state for reader return
        let previousPageId = 'home'; 
        
        // Store mock file name for Admin form
        let formDocumentFileName = 'No file selected (Mock)';

        // ====================================
        // 5.1. Core UI Functions & Alert/Toast
        // ====================================

        /**
         * Shows a temporary toast notification (simulating a custom alert/modal).
         * @param {string} title - The title of the toast.
         * @param {string} message - The content message.
         */
        function alertCustom(title, message) {
            console.log(`${title}: ${message}`); 
            const header = document.getElementById('floating-header');
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 p-4 rounded-xl bg-backup text-gray-900 font-semibold shadow-2xl z-50 transition-all duration-300 transform translate-x-full opacity-0';
            toast.innerHTML = `<strong>${title}</strong>: ${message.substring(0, 50)}...`;
            header.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 50);

            // Hide toast
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }


        /**
         * Switches the visible page section based on the ID.
         * @param {string} pageId - The ID of the page section to show (e.g., 'home', 'profile').
         */
        function navigate(pageId) {
            // Save current visible page ID before navigating away
            const currentPageEl = document.querySelector('.page-content.page-visible');
            if (currentPageEl && currentPageEl.id !== 'reading-page') {
                previousPageId = currentPageEl.id.replace('-page', '');
            }

            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('page-visible');
            });

            // Special handling for 'activity' based on user role
            if (pageId === 'activity') {
                if (userRole === 'Admin') {
                    // Navigate to the Admin Dashboard wrapper page
                    document.getElementById('admin-dashboard-page').classList.remove('hidden');
                    document.getElementById('admin-dashboard-page').classList.add('page-visible');
                    renderAdminSection('dashboard'); // Render the default admin section
                } else {
                    // Navigate to the regular User Activity page
                    document.getElementById('user-activity-page').classList.remove('hidden');
                    document.getElementById('user-activity-page').classList.add('page-visible');
                    renderUserActivityPage(); // Render user activity content
                }
                updateActiveNav('activity');
                window.scrollTo(0, 0);
                return;
            }
            
            // Hide admin wrappers if navigating to a non-admin page
            document.getElementById('admin-dashboard-page').classList.add('hidden');
            document.getElementById('admin-product-form-page').classList.add('hidden');
            document.getElementById('admin-offer-form-page').classList.add('hidden');


            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('page-visible');
                updateActiveNav(pageId);
                window.scrollTo(0, 0); 
                
                // Trigger content rendering for the new page
                if (pageId === 'home') {
                    renderHomeLibraryShelf();
                    renderProductListings();
                }
                if (pageId === 'search') initSearchPage();
                if (pageId === 'profile') updateProfileUI();
                if (pageId === 'cart') renderCartPage();
                if (pageId === 'wallet') renderWalletPage();
                if (pageId === 'bookmarks') renderBookmarksPage();
                if (pageId === 'offers') renderOffersPage();
                if (pageId === 'library') renderLibraryPage(); // NEW: Library Page rendering
                
            }
        }
        
        /**
         * UPDATED: Opens the PDF or Markdown reading interface in a dedicated full-screen view.
         * @param {number} id - Product ID.
         */
        function openReader(id) {
            const product = DUMMY_PRODUCTS.find(p => p.id === id);
            if (!product) {
                alertCustom('Error', 'Document not found.');
                return;
            }
            
            const readerPage = document.getElementById('reading-page');
            
            // 1. Hide main UI elements and adjust body styling
            document.getElementById('floating-header').classList.add('hidden');
            document.getElementById('bottom-nav').classList.add('hidden');
            document.body.classList.add('reader-active');
            
            // 2. Render the reader content
            let contentHTML = `
                <!-- Reader Top Bar (Fixed) -->
                <div class="sticky top-0 left-0 right-0 z-10 bg-gray-900/95 backdrop-blur-md p-3 flex justify-between items-center shadow-lg">
                    <button onclick="closeReader()" class="text-white hover:text-secondary transition text-lg px-2">
                        <i class="fas fa-arrow-left mr-2"></i> Back to App
                    </button>
                    <h4 class="text-white text-base font-semibold truncate max-w-[60%]">${product.title}</h4>
                    <button onclick="toggleAudioControls()" class="text-gray-400 hover:text-primary transition text-lg px-2">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            `;
            
            if (product.pdfUrl) {
                // PDF Viewer (iframe with proper styling and embedding)
                contentHTML += `
                    <div class="pdf-container w-full h-[calc(100vh-60px)]">
                        <iframe id="reader-iframe" src="${product.pdfUrl}" title="${product.title} PDF Document" 
                            class="w-full h-full border-0" 
                            type="application/pdf" 
                            allowfullscreen>
                            PDF viewing is not supported in your browser.
                        </iframe>
                    </div>
                `;
            } else {
                // Markdown/Text Content Viewer (Simulated)
                // Note: We are using very basic string replacement for Markdown simulation.
                let formattedContent = product.content
                    .replace(/## (.*)/g, '<h2>$1</h2>')
                    .replace(/### (.*)/g, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\\(.*?)\\ /g, '`$1` ');
                
                contentHTML += `
                    <div class="reader-content px-4">
                        ${formattedContent}
                        <div class="h-20"></div> <!-- Footer spacing -->
                    </div>
                `;
            }
            
            // Add audio controls drawer
            contentHTML += `
                <!-- Audio Controls Drawer -->
                <div id="audio-controls-drawer" class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur-md p-4 rounded-t-xl shadow-lg transform translate-y-full transition-transform duration-300 z-20 h-1/4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white font-bold">Audio Controls</h3>
                        <button onclick="toggleAudioControls()" class="text-gray-400 hover:text-primary">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="flex flex-col space-y-4">
                        <!-- Playback Controls -->
                        <div class="flex justify-center space-x-6">
                            <button class="text-white text-xl"><i class="fas fa-step-backward"></i></button>
                            <button class="text-white text-2xl"><i class="fas fa-play-circle"></i></button>
                            <button class="text-white text-xl"><i class="fas fa-step-forward"></i></button>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full w-1/3"></div>
                        </div>
                        
                        <!-- Voice Model Selection -->
                        <div class="flex items-center space-x-2">
                            <label class="text-white text-sm">Voice Model:</label>
                            <select class="bg-gray-800 text-white rounded px-2 py-1 text-sm">
                                <option value="default">Default</option>
                                <option value="male1">Male Voice 1</option>
                                <option value="female1">Female Voice 1</option>
                                <option value="male2">Male Voice 2</option>
                                <option value="female2">Female Voice 2</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            readerPage.innerHTML = contentHTML;
            readerPage.classList.remove('hidden');
            readerPage.classList.add('page-visible');
        }

        /**
         * UPDATED: Closes the reading interface and returns to the previous page.
         */
        function closeReader() {
             const readerPage = document.getElementById('reading-page');
             
             // 1. Restore main UI elements and body styling
             document.getElementById('floating-header').classList.remove('hidden');
             document.getElementById('bottom-nav').classList.remove('hidden');
             document.body.classList.remove('reader-active');
             
             // 2. Hide reader page
             readerPage.classList.add('hidden');
             readerPage.classList.remove('page-visible');
             
             // 3. Navigate back to the page the reader was opened from
             navigate(previousPageId);
        }


        /**
         * Updates the active state of the bottom navigation bar.
         * @param {string} activePage - The currently active page ID.
         */
        function updateActiveNav(activePage) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const targetPage = item.getAttribute('onclick').match(/navigate\('(.+?)'\)/)?.[1];
                
                // Set the default state for nav items
                item.classList.remove('text-primary');
                item.classList.add('text-gray-400');
                
                // Check if the current page matches a major nav item
                if (activePage === 'home' && targetPage === 'home') {
                    item.classList.add('text-primary');
                } else if (activePage === 'profile' && targetPage === 'profile') {
                    item.classList.add('text-primary');
                } else if (activePage === 'cart' && targetPage === 'cart') {
                    item.classList.add('text-primary');
                } else if (activePage === 'activity' && targetPage === 'activity') {
                    item.classList.add('text-primary');
                } else if (activePage === 'settings' && targetPage === 'settings') {
                    item.classList.add('text-primary');
                }
            });
        }
        
        /**
         * Updates the header and profile elements (Token count, Cart count, Bookmark count).
         */
        function updateHeaderUI() {
            document.getElementById('token-wallet-display').textContent = userWalletTokens;
            document.getElementById('cart-count').textContent = cartItems.length;
            
            if (cartItems.length === 0) {
                 document.getElementById('cart-count').classList.add('hidden');
            } else {
                 document.getElementById('cart-count').classList.remove('hidden');
            }
            
            // Update wallet page if active
            const walletBalanceEl = document.getElementById('wallet-balance-display');
            if (walletBalanceEl) walletBalanceEl.textContent = userWalletTokens;

            // Update role switch display on Home page
            const roleEl = document.getElementById('current-role');
            const switchLabel = document.getElementById('switch-role-label');
            if (roleEl && switchLabel) {
                roleEl.textContent = userRole;
                switchLabel.textContent = userRole === 'Admin' ? 'User' : 'Admin';
                roleEl.classList.toggle('text-tertiary', userRole === 'Admin');
                roleEl.classList.toggle('text-secondary', userRole === 'User');
            }
        }

        // ====================================
        // NEW: Role Toggling Logic
        // ====================================
        function toggleUserRole() {
            userRole = userRole === 'Admin' ? 'User' : 'Admin';
            updateHeaderUI();
            alertCustom('Role Switched', `You are now simulating being a **${userRole}**.`);
            
            // If currently on an activity-related page, navigate again to refresh content
            const activePage = document.querySelector('.page-content.page-visible');
            if (activePage && (activePage.id === 'admin-dashboard-page' || activePage.id === 'user-activity-page')) {
                navigate('activity');
            }
        }
        
        /**
         * Updates profile page dynamic data.
         */
        function updateProfileUI() {
            const bookmarkCountEl = document.getElementById('profile-bookmark-count');
            if (bookmarkCountEl) {
                bookmarkCountEl.textContent = bookmarkedProductIds.length;
            }
            
            // Update profile details display from currentUser state
            const nameDisplay = document.getElementById('profile-name-display');
            const emailDisplay = document.getElementById('profile-email-display');
            
            if (nameDisplay) nameDisplay.textContent = currentUser.name;
            if (emailDisplay) emailDisplay.textContent = currentUser.email;
        }
        
        // ====================================
        // 5.1.5. Profile Edit Modal Logic
        // ====================================

        /**
         * Opens the profile edit modal and pre-fills the form.
         */
        function openEditProfileModal() {
            const modal = document.getElementById('edit-profile-modal');
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-email').value = currentUser.email;

            modal.classList.remove('opacity-0', 'pointer-events-none');
            // Animate content by targeting the immediate child div (the actual card)
            modal.querySelector('div').classList.remove('scale-95'); 
        }

        /**
         * Closes the profile edit modal.
         */
        function closeEditProfileModal() {
            const modal = document.getElementById('edit-profile-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-95');
        }

        /**
         * Handles the profile form submission (simulated data update).
         * @param {Event} event - The form submission event.
         */
        function handleProfileUpdate(event) {
            event.preventDefault();

            const newName = document.getElementById('edit-name').value.trim();
            const newEmail = document.getElementById('edit-email').value.trim();

            // Simple validation simulation
            if (!newName || !newEmail) {
                alertCustom('Validation Error', 'Name and Email cannot be empty.');
                return;
            }

            // Simulate API update
            currentUser.name = newName;
            currentUser.email = newEmail;
            
            // Update UI elements on the profile page
            updateProfileUI();

            closeEditProfileModal();
            alertCustom('Success', 'Profile updated successfully!');
        }


        // ====================================
        // 5.2. Component: Product Card (HORIZONTAL LAYOUT)
        // ====================================

        /**
         * Generates the HTML for a single product card (used on Home/Search/Library List).
         * @param {object} product - The product data object.
         * @returns {string} HTML string.
         */
        function createProductCard(product) {
            const isBookmarked = bookmarkedProductIds.includes(product.id);
            
            const priceText = product.isFree ? 'FREE' : `${product.price}`;
            const icon = product.isFree ? 'fas fa-gift' : 'fas fa-coins';

            return `
                <div class="card-gradient rounded-xl p-4 flex flex-row space-x-4 items-start shadow-2xl relative" onclick="showProductDetails(${product.id})">
                    <!-- Left: Media (Fixed size) with Cover Image -->
                    <div class="w-24 h-32 flex-shrink-0 bg-gray-700/50 rounded-lg flex items-center justify-center relative overflow-hidden">
                        ${product.coverImage ? 
                          `<img src="${product.coverImage}" alt="${product.title}" class="w-full h-full object-cover">` : 
                          `<i class="fas fa-file-alt text-3xl text-white/50"></i>`
                        }
                        <!-- Type Badge -->
                        <span class="absolute top-1 left-1 text-[10px] font-semibold px-1.5 py-0.5 rounded-full bg-gray-900 text-white shadow-md">${product.type}</span>
                    </div>
                    
                    <!-- Right: Content and Actions -->
                    <div class="flex-1 flex flex-col min-w-0">
                        <!-- Content -->
                        <h4 class="font-heading text-lg font-bold truncate text-white mb-1">${product.title}</h4>
                        <p class="text-xs text-gray-400 mb-2 line-clamp-1">${product.description}</p>
                        
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-1 mb-2">
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-gray-800 text-gray-300">${product.category}</span>
                            ${product.tags.map(tag => `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-gray-800/50 text-gray-400">${tag}</span>`).join('')}
                        </div>

                        <!-- Price & Actions -->
                        <div class="mt-auto flex justify-between items-center pt-2 border-t border-gray-700/50">
                            <div class="flex items-center">
                                <i class="${icon} text-sm mr-2 ${product.isFree ? 'text-backup' : 'text-tertiary'}"></i>
                                <span class="text-lg font-extrabold ${product.isFree ? 'text-backup' : 'text-tertiary'}">${priceText}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Add to Cart Button -->
                                <button class="w-8 h-8 rounded-full btn-primary-gradient text-white shadow-lg hover:shadow-xl hover:scale-105 transition" onclick="event.stopPropagation(); addToCart(${product.id});">
                                    <i class="fas fa-shopping-cart text-sm"></i>
                                </button>
                                <!-- Bookmark Button -->
                                <button class="w-8 h-8 rounded-full bg-gray-900/70 backdrop-blur-sm text-lg hover:bg-gray-800 transition" 
                                        onclick="event.stopPropagation(); toggleBookmark(${product.id});">
                                    <i id="bookmark-icon-${product.id}" class="${isBookmarked ? 'fas text-secondary' : 'far text-gray-400'} fa-bookmark text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ====================================
        // 5.3. Home Page Logic (Filtering, Pagination & Rendering)
        // ====================================

        /**
         * NEW: Creates and renders the small rounded cards for the Home Library Shelf.
         * The card click handler is updated to navigate to Product Details Page first.
         */
        function renderHomeLibraryShelf() {
            const container = document.getElementById('home-library-shelf');
            const wrapper = document.getElementById('library-shelf-wrapper'); // TARGET NEW ID
            
            if (!container || !wrapper) return; // SAFEGUARD AGAINST NULL

            // Only show up to 6 items on the shelf
            const ownedProducts = DUMMY_PRODUCTS.filter(p => bookmarkedProductIds.includes(p.id));
            const productsToShow = ownedProducts.slice(0, 6); 

            if (productsToShow.length === 0) {
                 container.innerHTML = '<p class="text-sm text-gray-500">Your library is empty. Bookmark or purchase a document!</p>';
                 wrapper.classList.add('hidden');
                 return;
            }
            
            wrapper.classList.remove('hidden');


            const cards = productsToShow.map(p => `
                <div class="flex-shrink-0 w-24 sm:w-28 cursor-pointer group" onclick="showProductDetails(${p.id})">
                    <!-- Rounded Cover with Image -->
                    <div class="w-full h-32 sm:h-36 card-gradient rounded-xl flex flex-col items-center justify-center p-2 text-center shadow-lg group-hover:shadow-primary/50 transition overflow-hidden">
                        ${p.coverImage ? 
                          `<div class="w-full h-20 mb-1 overflow-hidden rounded-lg">
                              <img src="${p.coverImage}" alt="${p.title}" class="w-full h-full object-cover">
                           </div>` : 
                          `<i class="fas fa-file-alt text-2xl text-backup/70 mb-1"></i>`
                        }
                        <p class="text-xs font-semibold text-white truncate w-full px-1">${p.title}</p>
                        <p class="text-[10px] text-gray-400">${p.type}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = cards;
        }


        /**
         * Changes the current page and re-renders the listings.
         * @param {number} page - The page number to navigate to.
         */
        function goToPage(page) {
            if (page > 0) {
                currentPage = page;
                renderProductListings();
                window.scrollTo(0, 0); // Scroll to top when page changes
            }
        }
        
        /**
         * Dynamically generates and renders the pagination controls.
         * @param {number} totalPages - The total number of pages available.
         */
        function renderPaginationControls(totalPages) {
            const paginationContainer = document.getElementById('pagination-container');
            if (!paginationContainer) return;

            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = '';

            // Previous Button
            html += `
                <button onclick="goToPage(${currentPage - 1})" 
                    class="px-4 py-2 rounded-full bg-gray-700/50 text-white transition hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" 
                    ${currentPage <= 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            // Page Buttons
            // Show up to 5 buttons max, centered around current page
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (endPage - startPage < 4) {
                if (currentPage < totalPages - 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else if (currentPage > 2) {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                const activeClass = isActive ? 'btn-primary-gradient text-white' : 'bg-gray-700/50 text-white hover:bg-gray-600';
                html += `
                    <button onclick="goToPage(${i})" 
                        class="px-4 py-2 rounded-full font-semibold transition ${activeClass}">
                        ${i}
                    </button>
                `;
            }

            // Next Button
            html += `
                <button onclick="goToPage(${currentPage + 1})" 
                    class="px-4 py-2 rounded-full bg-gray-700/50 text-white transition hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" 
                    ${currentPage >= totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            paginationContainer.innerHTML = html;
        }


        /**
         * Renders the product listings based on the current filter and page.
         */
        function renderProductListings() {
            const container = document.getElementById('product-listing-container');
            
            // 1. Filtering
            const filteredProducts = DUMMY_PRODUCTS.filter(p => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'Free') return p.isFree;
                return p.type === currentFilter;
            });

            // 2. Pagination Logic
            const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
            
            // Ensure currentPage is within bounds after filtering/re-rendering
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 0;
            } else if (currentPage === 0 && totalPages > 0) {
                 currentPage = 1;
            }
            
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const productsToDisplay = filteredProducts.slice(startIndex, endIndex);

            // 3. Rendering Products
            if (productsToDisplay.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400 p-8 card-gradient rounded-xl">No products match your current filters.</p>';
            } else {
                container.innerHTML = productsToDisplay.map(createProductCard).join('');
            }

            // 4. Render Pagination
            renderPaginationControls(totalPages);
            updateHeaderUI();
        }

        /**
         * Sets the filter and re-renders the product list.
         * @param {string} filter - The filter type.
         */
        function applyFilter(filter) {
            currentFilter = filter;
            currentPage = 1; // Reset page on filter change
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            document.querySelector(`.filter-btn[data-filter="${filter}"]`).classList.add('filter-active');
            renderProductListings();
        }

        /**
         * Simulates adding a product to the cart.
         * @param {number} id - Product ID.
         */
        function addToCart(id) {
            const product = DUMMY_PRODUCTS.find(p => p.id === id);
            if (product && !product.isFree && !cartItems.some(item => item.id === id)) {
                cartItems.push(product);
                updateHeaderUI();
                alertCustom('Added to Cart', `${product.title} added successfully.`);
            } else if (product.isFree) {
                 alertCustom('Free Document', `${product.title} is free and ready for direct download!`);
            } else {
                alertCustom('Item in Cart', `${product.title} is already in your cart.`);
            }
        }

        /**
         * Toggles the bookmark state of a product.
         * @param {number} id - Product ID.
         */
        function toggleBookmark(id) {
            const index = bookmarkedProductIds.indexOf(id);
            const icon = document.getElementById(`bookmark-icon-${id}`);

            if (index > -1) {
                // Remove bookmark
                bookmarkedProductIds.splice(index, 1);
                if (icon) { // Check for home page icon
                    icon.classList.replace('fas', 'far');
                    icon.classList.remove('text-secondary');
                }
                alertCustom('Removed Bookmark', 'Document removed from bookmarks.');
            } else {
                // Add bookmark
                bookmarkedProductIds.push(id);
                if (icon) { // Check for home page icon
                    icon.classList.replace('far', 'fas');
                    icon.classList.add('text-secondary');
                }
                alertCustom('Bookmarked', 'Document added to bookmarks.');
            }
            
            // Re-render relevant pages if visible
            if (document.getElementById('bookmarks-page').classList.contains('page-visible')) {
                renderBookmarksPage();
            }
            if (document.getElementById('library-page').classList.contains('page-visible')) {
                // Need to re-render the Library page if we change its contents
                renderLibraryPage(); 
            }
            // Re-render home shelf to reflect change
            renderHomeLibraryShelf();

            // Update the product details page bookmark button if visible
            const detailsIcon = document.getElementById('details-bookmark-btn');
            if (detailsIcon) {
                 const iconElement = detailsIcon.querySelector('i');
                 if (index > -1) {
                    iconElement.classList.replace('fas', 'far');
                    iconElement.classList.remove('text-secondary');
                 } else {
                    iconElement.classList.replace('far', 'fas');
                    iconElement.classList.add('text-secondary');
                 }
            }
            updateProfileUI(); // Update profile count
        }
        
        // ====================================
        // 5.4. Product Details Logic
        // ====================================
        
        /**
         * Simulates showing a product details page.
         * @param {number} id - Product ID.
         */
        function showProductDetails(id) {
            const product = DUMMY_PRODUCTS.find(p => p.id === id);
            if (product) {
                renderProductDetails(product);
                navigate('product-details');
            }
        }
        
        /**
         * Renders the Product Details Page content dynamically.
         * @param {object} product - The product data object.
         */
        function renderProductDetails(product) {
            const isBookmarked = bookmarkedProductIds.includes(product.id);
            const isFree = product.isFree;
            const priceText = isFree ? 'FREE' : `${product.price} Tokens`;
            const actionButtonText = isFree ? 'Download Now' : `Purchase for ${product.price} Tokens`;
            
            // Determine if the user has purchased/downloaded the content (mock logic)
            // A product is considered 'owned' if it's in the bookmark list
            const isOwned = bookmarkedProductIds.includes(product.id);
            
            let primaryActionButton;
            if (isOwned) {
                // Modified button to open reader
                primaryActionButton = `<button class="w-full py-4 rounded-xl bg-backup hover:bg-backup/80 text-gray-900 text-lg font-bold shadow-2xl hover:scale-[1.02] transition" onclick="openReader(${product.id})">
                                        <i class="fas fa-book-reader mr-2"></i> Read Document
                                    </button>`;
            } else {
                 primaryActionButton = `<button class="w-full py-4 rounded-xl btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-[1.02] transition" onclick="confirmPurchase(${product.id})">
                                        <i class="fas fa-shopping-bag mr-2"></i> ${actionButtonText}
                                    </button>`;
            }


            const pageContainer = document.getElementById('product-details-page');
            
            const html = `
                <div class="max-w-4xl mx-auto">
                    <!-- Back Button -->
                    <button onclick="navigate('home')" class="text-gray-300 hover:text-primary mb-6 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Listings
                    </button>

                    <div class="grid lg:grid-cols-3 gap-8">
                        <!-- Left Column: Media & Actions -->
                        <div class="lg:col-span-1">
                            <!-- Cover Image -->
                            <div class="h-64 card-gradient rounded-xl flex items-center justify-center mb-6 shadow-2xl overflow-hidden">
                                ${product.coverImage ? 
                                  `<img src="${product.coverImage}" alt="${product.title}" class="w-full h-full object-cover">` : 
                                  `<i class="fas fa-book-open text-6xl text-tertiary/60"></i>`
                                }
                            </div>

                            <!-- Purchase/Action Button -->
                            ${primaryActionButton}
                            
                            <!-- Secondary Actions -->
                            <div class="flex justify-between mt-4 space-x-3">
                                <button id="details-bookmark-btn" onclick="toggleBookmark(${product.id})" class="flex-1 py-3 card-gradient rounded-xl text-center text-gray-300 hover:text-secondary transition">
                                    <i class="${isBookmarked ? 'fas text-secondary' : 'far'} fa-bookmark text-xl"></i>
                                </button>
                                <button onclick="addToCart(${product.id})" class="flex-1 py-3 card-gradient rounded-xl text-center text-gray-300 hover:text-backup transition">
                                    <i class="fas fa-cart-plus text-xl"></i>
                                </button>
                                <button onclick="alertCustom('Share', 'Share link copied for ${product.title}.')" class="flex-1 py-3 card-gradient rounded-xl text-center text-gray-300 hover:text-tertiary transition">
                                    <i class="fas fa-share-alt text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Right Column: Details & Reviews -->
                        <div class="lg:col-span-2">
                            <!-- Header & Price -->
                            <h1 class="text-4xl font-heading font-extrabold mb-3 text-white">${product.title}</h1>
                            <div class="flex items-center space-x-4 mb-4 pb-4 border-b border-gray-700/50">
                                <span class="text-3xl font-extrabold ${isFree ? 'text-backup' : 'text-tertiary'}">${priceText}</span>
                                <span class="text-sm text-gray-400">|</span>
                                <div class="flex items-center text-sm text-gray-400">
                                    <i class="fas fa-star text-tertiary mr-1"></i> ${product.rating} (${product.reviewCount} Reviews)
                                </div>
                            </div>
                            
                            <!-- Metadata -->
                            <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-400">
                                <p><span class="font-bold text-white">Type:</span> ${product.type}</p>
                                <p><span class="font-bold text-white">Author:</span> ${product.author}</p>
                                <p><span class="font-bold text-white">Category:</span> ${product.category}</p>
                                <p><span class="font-bold text-white">Pages:</span> ${product.pages}</p>
                            </div>

                            <!-- Description -->
                            <h3 class="text-xl font-heading font-bold mb-3 text-primary">Overview</h3>
                            <p class="text-gray-300 mb-8 leading-relaxed">${product.details}</p>

                            <!-- Tags -->
                            <div class="flex flex-wrap gap-2 mb-10">
                                ${product.tags.map(tag => `<span class="text-xs font-medium px-3 py-1 rounded-full bg-gray-700 text-gray-300">${tag}</span>`).join('')}
                            </div>
                            
                            <!-- Comments Placeholder -->
                            <h3 class="text-xl font-heading font-bold mb-4 text-primary">User Reviews (${product.reviewCount})</h3>
                            <div class="space-y-4">
                                <div class="card-gradient rounded-xl p-4">
                                    <p class="font-bold text-sm text-white">Alex M. <span class="text-xs text-tertiary ml-2"><i class="fas fa-star"></i> 5.0</span></p>
                                    <p class="text-gray-400 text-sm mt-1">"The best notes I've bought! Super clear and highly detailed diagrams."</p>
                                </div>
                                <div class="card-gradient rounded-xl p-4">
                                    <p class="font-bold text-sm text-white">Sarah K. <span class="text-xs text-tertiary ml-2"><i class="fas fa-star"></i> 4.0</span></p>
                                    <p class="text-gray-400 text-sm mt-1">"Great content, but wish there were more practice examples. Still worth the tokens!"</p>
                                </div>
                                <button class="mt-4 w-full py-2 bg-gray-700/50 rounded-lg text-gray-300 hover:bg-gray-700 transition">View All Reviews</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            pageContainer.innerHTML = html;
        }

        // ====================================
        // 5.5. Search Page Logic
        // ====================================

        /**
         * Applies filters and search term to the product list.
         */
        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            currentSearchTerm = searchTerm;

            const resultsContainer = document.getElementById('search-results-container');
            const resultsHeading = document.getElementById('search-results-heading');

            const filteredAndSearchedProducts = DUMMY_PRODUCTS.filter(p => {
                // Text Search
                const matchesText = (p.title.toLowerCase().includes(searchTerm) || 
                                     p.description.toLowerCase().includes(searchTerm) ||
                                     p.author.toLowerCase().includes(searchTerm));

                if (!matchesText) return false;

                // Category Filter
                if (currentSearchCategory !== 'all' && p.category !== currentSearchCategory) return false;

                // Price Filter
                if (currentSearchPrice === 'free' && !p.isFree) return false;
                if (currentSearchPrice === 'premium' && p.isFree) return false;
                if (currentSearchPrice === 'all') return true;
                
                return true;
            });

            resultsHeading.textContent = `Results (${filteredAndSearchedProducts.length})`;
            
            if (filteredAndSearchedProducts.length === 0) {
                 resultsContainer.innerHTML = '<p class="col-span-full text-center text-gray-400 p-8 card-gradient rounded-xl">Sorry, no documents matched your search and filters.</p>';
            } else {
                resultsContainer.innerHTML = filteredAndSearchedProducts.map(createProductCard).join('');
            }
        }
        
        /**
         * Handles filter button clicks on the search page.
         * @param {string} type - 'category' or 'price'.
         * @param {string} value - The filter value.
         */
        function applySearchFilter(type, value) {
            // Reset active classes for the specific type
            document.querySelectorAll(`.search-filter-btn[data-filter-type="${type}"]`).forEach(btn => {
                btn.classList.remove('filter-active');
            });
            // Set active class for the clicked button
            document.querySelector(`.search-filter-btn[data-filter-value="${value}"][data-filter-type="${type}"]`).classList.add('filter-active');

            // Update state
            if (type === 'category') {
                currentSearchCategory = value;
            } else if (type === 'price') {
                currentSearchPrice = value;
            }

            searchProducts();
        }

        /**
         * Attaches event listeners and performs initial search.
         */
        function initSearchPage() {
            // Ensure listeners are attached only once or safely replace old ones
            const filterButtons = document.querySelectorAll('.search-filter-btn');
            filterButtons.forEach(button => {
                // Ensure no duplicate listeners if initSearchPage is called multiple times
                button.onclick = (e) => {
                    const type = e.target.getAttribute('data-filter-type');
                    const value = e.target.getAttribute('data-filter-value');
                    applySearchFilter(type, value);
                };
            });
             // Perform initial search (default state)
             searchProducts();
        }

        
        // ====================================
        // 5.6. Carousel Logic
        // ====================================
        let currentSlide = 0;
        const totalSlides = 2; // Hardcoded for the two dummy slides
        const carousel = document.getElementById('offer-carousel');
        let autoScrollInterval;
        const scrollDelay = 5000; // 5 seconds

        /**
         * Updates the carousel position and dot indicators.
         */
        function updateCarousel() {
            const offset = -currentSlide * 100;
            carousel.style.transform = `translateX(${offset}%)`;

            for (let i = 0; i < totalSlides; i++) {
                const dot = document.getElementById(`carousel-dot-${i}`);
                if (dot) {
                    dot.classList.remove('opacity-80');
                    dot.classList.add('opacity-40');
                }
            }
            const activeDot = document.getElementById(`carousel-dot-${currentSlide}`);
            if (activeDot) {
                activeDot.classList.add('opacity-80');
                activeDot.classList.remove('opacity-40');
            }
        }

        /**
         * Moves to the next slide.
         */
        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            updateCarousel();
        }

        /**
         * Moves to the previous slide.
         */
        function prevSlide() {
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            updateCarousel();
        }

        /**
         * Starts the automatic carousel rotation.
         */
        function startAutoScroll() {
            stopAutoScroll();
            autoScrollInterval = setInterval(nextSlide, scrollDelay);
        }

        /**
         * Stops the automatic carousel rotation.
         */
        function stopAutoScroll() {
            if (autoScrollInterval) {
                clearInterval(autoScrollInterval);
            }
        }
        
        /**
         * Handles manual navigation to the next slide and resets the timer.
         * @param {Event} event 
         */
        function manualNextSlide(event) {
             event.stopPropagation(); 
             stopAutoScroll();
             nextSlide();
             startAutoScroll();
        }
        
        /**
         * Handles manual navigation to the previous slide and resets the timer.
         * @param {Event} event 
         */
        function manualPrevSlide(event) {
             event.stopPropagation(); 
             stopAutoScroll();
             prevSlide();
             startAutoScroll();
        }


        // ====================================
        // 5.7. Cart Page Logic
        // ====================================

        /**
         * Generates the HTML for a single item in the cart list.
         * @param {object} item - The product data object.
         */
        function createCartItem(item) {
            return `
                <div class="card-gradient rounded-xl p-4 flex items-center space-x-4 shadow-lg">
                    <div class="w-16 h-16 flex-shrink-0 bg-gray-700/50 rounded-lg flex items-center justify-center overflow-hidden">
                        ${item.coverImage ? 
                          `<img src="${item.coverImage}" alt="${item.title}" class="w-full h-full object-cover">` : 
                          `<i class="fas fa-file-alt text-xl text-white/50"></i>`
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <!-- UPDATED: Added onclick to navigate to details page -->
                        <h4 class="font-heading text-lg font-bold truncate text-white cursor-pointer hover:text-primary transition" 
                            onclick="showProductDetails(${item.id})">
                            ${item.title}
                        </h4>
                        <p class="text-sm text-gray-400">by ${item.author}</p>
                    </div>
                    <div class="text-right flex items-center space-x-4">
                        <span class="text-lg font-extrabold text-tertiary">${item.price} T.</span>
                        <!-- MODIFIED: Changed from text button to icon button -->
                        <button onclick="removeCartItem(${item.id})" class="text-xl text-red-500 hover:text-red-400 transition p-2 rounded-full hover:bg-gray-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Removes an item from the cart state and re-renders the page.
         * @param {number} id - Product ID to remove.
         */
        function removeCartItem(id) {
            const initialLength = cartItems.length;
            cartItems = cartItems.filter(item => item.id !== id);
            if (cartItems.length < initialLength) {
                alertCustom('Removed', 'Item removed from cart.');
                renderCartPage();
            }
        }

        /**
         * Renders the entire Cart Page content.
         */
        function renderCartPage() {
            const container = document.getElementById('cart-items-container');
            const itemCountEl = document.getElementById('summary-item-count');
            const subtotalEl = document.getElementById('summary-subtotal');
            const totalCostEl = document.getElementById('summary-total-cost');
            const checkoutBtn = document.getElementById('checkout-btn');
            const statusEl = document.getElementById('checkout-status');

            if (cartItems.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400 p-8 card-gradient rounded-xl">Your cart is empty. Add documents to purchase!</p>';
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('disabled:bg-gray-700/50');
                itemCountEl.textContent = 0;
                subtotalEl.textContent = '0 Tokens';
                totalCostEl.textContent = '0 Tokens';
                statusEl.classList.add('hidden');
                updateHeaderUI();
                return;
            }

            const totalCost = cartItems.reduce((sum, item) => sum + item.price, 0);
            
            container.innerHTML = cartItems.map(createCartItem).join('');
            itemCountEl.textContent = cartItems.length;
            subtotalEl.textContent = `${totalCost} Tokens`;
            totalCostEl.textContent = `${totalCost} Tokens`;
            
            // Checkout button logic
            if (totalCost > userWalletTokens) {
                checkoutBtn.disabled = true;
                checkoutBtn.classList.remove('btn-primary-gradient');
                checkoutBtn.classList.add('bg-red-700/50', 'disabled:bg-red-700/50');
                statusEl.classList.remove('hidden');
            } else {
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('bg-red-700/50', 'disabled:bg-red-700/50');
                checkoutBtn.classList.add('btn-primary-gradient');
                statusEl.classList.add('hidden');
            }
            updateHeaderUI();
        }
        
        /**
         * Simulates the checkout process.
         */
        function checkout() {
            const totalCost = cartItems.reduce((sum, item) => sum + item.price, 0);
            
            if (totalCost > userWalletTokens) {
                alertCustom('Error', 'Insufficient tokens. Please buy more.');
                return;
            }
            
            userWalletTokens -= totalCost;
            
            // Add purchases to transaction history (mock)
            cartItems.forEach(item => {
                TRANSACTION_HISTORY.unshift({ 
                    id: Date.now() + item.id, 
                    type: 'Debit', 
                    amount: item.price, 
                    date: new Date().toISOString().slice(0, 10), 
                    description: `Purchased ${item.title}` 
                });
            });

            cartItems = []; // Clear cart
            
            alertCustom('Purchase Complete', `Transaction successful! ${totalCost} tokens spent.`);
            renderCartPage();
            updateHeaderUI();
        }

        // ====================================
        // 5.8. Wallet Page Logic
        // ====================================

        /**
         * Renders the Wallet Page content.
         */
        function renderWalletPage() {
            const historyContainer = document.getElementById('transaction-history-container');
            const balanceEl = document.getElementById('wallet-balance-display');
            
            balanceEl.textContent = userWalletTokens;

            historyContainer.innerHTML = TRANSACTION_HISTORY.map(tx => {
                const color = tx.type === 'Credit' ? 'text-backup' : 'text-red-400';
                const sign = tx.type === 'Credit' ? '+' : '-';
                const icon = tx.type === 'Credit' ? 'fas fa-plus-circle' : 'fas fa-minus-circle';
                
                return `
                    <div class="card-gradient rounded-xl p-4 flex justify-between items-center shadow-md">
                        <div class="flex items-center space-x-3">
                            <i class="${icon} ${color}"></i>
                            <div>
                                <p class="font-semibold text-white">${tx.description}</p>
                                <p class="text-xs text-gray-500">${tx.date}</p>
                            </div>
                        </div>
                        <span class="font-bold text-lg ${color}">${sign}${tx.amount} T.</span>
                    </div>
                `;
            }).join('');
            
            updateHeaderUI();
        }

        /**
         * Opens the buy tokens modal.
         */
        function openBuyTokensModal() {
            const modal = document.getElementById('buy-tokens-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95'); 
        }

        /**
         * Closes the buy tokens modal.
         */
        function closeBuyTokensModal() {
            const modal = document.getElementById('buy-tokens-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-95');
        }
        
        /**
         * Simulates purchasing tokens.
         * @param {number} amount - The amount of tokens purchased.
         */
        function buyTokens(amount) {
            userWalletTokens += amount;
            
            // Add to transaction history
            TRANSACTION_HISTORY.unshift({ 
                id: Date.now(), 
                type: 'Credit', 
                amount: amount, 
                date: new Date().toISOString().slice(0, 10), 
                description: `Purchased ${amount} Tokens` 
            });

            closeBuyTokensModal();
            alertCustom('Purchase Complete', `${amount} tokens added to your wallet.`);
            renderWalletPage(); // Re-render wallet page
            updateHeaderUI();
        }

        // ====================================
        // 5.9. Bookmarks Page Logic
        // ====================================
        
        /**
         * Renders the Bookmarks Page content.
         */
        function renderBookmarksPage() {
            const container = document.getElementById('bookmarks-list-container');
            const emptyMsg = document.getElementById('bookmarks-empty-message');
            
            // Filter DUMMY_PRODUCTS based on bookmarkedProductIds
            const bookmarkedProducts = DUMMY_PRODUCTS.filter(p => bookmarkedProductIds.includes(p.id));
            
            if (bookmarkedProducts.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                
                // Use a simplified version of the horizontal card for list display
                container.innerHTML = bookmarkedProducts.map(p => {
                    const priceText = p.isFree ? 'FREE' : `${p.price} T.`;
                    // UPDATED: Action button now calls openReader
                    const actionButton = `<button onclick="openReader(${p.id})" class="px-3 py-1 text-sm bg-backup text-gray-900 rounded-full font-semibold hover:bg-backup/80 transition"><i class="fas fa-book-reader mr-1"></i> View/Download</button>`;
                    
                    return `
                        <div class="card-gradient rounded-xl p-4 flex items-center space-x-4 shadow-lg">
                            <div class="w-16 h-16 flex-shrink-0 bg-gray-700/50 rounded-lg flex items-center justify-center overflow-hidden">
                                ${p.coverImage ? 
                                  `<img src="${p.coverImage}" alt="${p.title}" class="w-full h-full object-cover">` : 
                                  `<i class="fas fa-bookmark text-xl text-secondary/70"></i>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-heading text-lg font-bold truncate text-white">${p.title}</h4>
                                <p class="text-xs text-gray-400">Price: ${priceText}</p>
                            </div>
                            <div class="flex space-x-2 items-center">
                                ${actionButton}
                                <!-- MODIFIED: Changed from text button to icon button -->
                                <button onclick="toggleBookmark(${p.id})" class="text-xl text-red-500 hover:text-red-400 transition p-2 rounded-full hover:bg-gray-700">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            updateProfileUI(); // Ensure the count is correct
        }
        
        // ====================================
        // 5.9.7. Library Page Logic (New)
        // ====================================
        let librarySortKey = 'title';
        let librarySearchTerm = '';
        
        /**
         * Filters and sorts the bookmarked products for the Library page.
         */
        function getFilteredAndSortedLibraryProducts() {
            let products = DUMMY_PRODUCTS.filter(p => bookmarkedProductIds.includes(p.id));
            
            // 1. Filter by Search Term
            if (librarySearchTerm) {
                const term = librarySearchTerm.toLowerCase();
                products = products.filter(p => 
                    p.title.toLowerCase().includes(term) ||
                    p.author.toLowerCase().includes(term) ||
                    p.category.toLowerCase().includes(term)
                );
            }

            // 2. Sort
            products.sort((a, b) => {
                if (librarySortKey === 'title') {
                    return a.title.localeCompare(b.title);
                } else if (librarySortKey === 'type') {
                    return a.type.localeCompare(b.type);
                } else if (librarySortKey === 'price') {
                    // Sort by price (tokens) ascending
                    return a.price - b.price; 
                }
                return 0;
            });
            
            return products;
        }
        
        /**
         * Renders the full Library Page content.
         */
        function renderLibraryPage() {
            const container = document.getElementById('library-page');
            const ownedProducts = getFilteredAndSortedLibraryProducts();
            
            const productListHTML = ownedProducts.map(p => {
                const isOwned = true; // By definition, everything here is owned/bookmarked
                const primaryActionButton = `<button class="w-full py-2 rounded-lg bg-backup hover:bg-backup/80 text-gray-900 text-sm font-bold transition mt-2" onclick="openReader(${p.id})">
                                                <i class="fas fa-book-reader mr-2"></i> Read Now
                                            </button>`;

                return `
                    <div class="card-gradient rounded-xl p-4 flex flex-col items-center justify-center text-center shadow-2xl relative">
                        <!-- Remove Bookmark Icon -->
                        <button class="absolute top-2 right-2 p-1 rounded-full bg-gray-900/70 text-red-500 hover:text-red-400 z-10" 
                                onclick="event.stopPropagation(); toggleBookmark(${p.id});">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                        
                        <!-- Book Cover Mock -->
                        <div class="w-20 h-28 bg-gray-700/50 rounded-lg flex items-center justify-center mb-3">
                             <i class="fas fa-file-alt text-3xl text-white/50"></i>
                        </div>

                        <h4 class="font-heading text-base font-bold truncate w-full px-1 text-white">${p.title}</h4>
                        <p class="text-xs text-gray-400">${p.type} by ${p.author}</p>
                        
                        ${primaryActionButton}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Back Button -->
                    <button onclick="navigate('home')" class="text-gray-300 hover:text-primary mb-6 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Home
                    </button>
                    
                    <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                        <span class="text-gradient">My</span> Digital Library
                    </h2>

                    <!-- Search and Sort Bar -->
                    <div class="card-gradient rounded-xl p-4 mb-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-center shadow-lg">
                        
                        <!-- Search Input -->
                        <div class="relative flex-1 w-full">
                            <input type="text" id="library-search-input" value="${librarySearchTerm}" oninput="updateLibrarySearch(this.value)" placeholder="Search title, author, or category..." 
                                class="w-full p-3 pl-10 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary focus:outline-none placeholder-gray-400 text-sm">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm"></i>
                        </div>
                        
                        <!-- Sort Dropdown -->
                        <div class="w-full md:w-auto">
                            <select id="library-sort-select" onchange="updateLibrarySort(this.value)"
                                    class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary focus:outline-none appearance-none cursor-pointer">
                                <option value="title" ${librarySortKey === 'title' ? 'selected' : ''}>Sort by Title</option>
                                <option value="type" ${librarySortKey === 'type' ? 'selected' : ''}>Sort by Type</option>
                                <option value="price" ${librarySortKey === 'price' ? 'selected' : ''}>Sort by Price (Tokens)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Library Products Grid -->
                    <h3 class="text-xl font-heading font-bold mb-4 text-white">Documents (${ownedProducts.length})</h3>
                    <div id="library-products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${ownedProducts.length > 0 ? productListHTML : 
                            `<p class="col-span-full text-center text-gray-400 p-8 card-gradient rounded-xl">
                                Your library is empty or no documents match your search.
                            </p>`}
                    </div>
                </div>
            `;
        }

        /**
         * Updates the search term for the library and re-renders.
         * @param {string} value - The new search term.
         */
        function updateLibrarySearch(value) {
            librarySearchTerm = value;
            renderLibraryPage();
        }

        /**
         * Updates the sort key for the library and re-renders.
         * @param {string} value - The new sort key.
         */
        function updateLibrarySort(value) {
            librarySortKey = value;
            renderLibraryPage();
        }

        // ====================================
        // 5.9.6. Offers Page Logic
        // ====================================
        
        /**
         * Renders the Offers Page content (static banner + dynamic offer cards).
         */
        function renderOffersPage() {
            const container = document.getElementById('offers-page');
            
            const activeOffers = DUMMY_OFFERS.filter(o => o.status === 'Active');

            const offerCards = activeOffers.map(offer => {
                const originalPrice = offer.productIds.reduce((sum, id) => {
                    const product = DUMMY_PRODUCTS.find(p => p.id === id);
                    return sum + (product ? product.price : 0);
                }, 0);
                const savings = originalPrice - offer.tokenPrice;
                const priceDisplay = offer.tokenPrice === 0 ? 'FREE' : `${offer.tokenPrice} Tokens`;

                return `
                    <div class="card-gradient rounded-xl p-6 shadow-xl border-l-4 border-primary/50 flex flex-col justify-between cursor-pointer hover:border-secondary transition" onclick="showOfferDetails(${offer.id})">
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-xl font-heading font-bold text-white">${offer.title}</h4>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-backup text-gray-900">${offer.discount}</span>
                            </div>
                            <p class="text-gray-400 text-sm mb-4">Duration: ${offer.duration}</p>
                        </div>
                        <div class="mt-auto pt-3 border-t border-gray-700/50">
                            <p class="text-sm text-gray-500 mb-1">Total Value: <s class="text-xs">${originalPrice} T.</s></p>
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold ${offer.tokenPrice === 0 ? 'text-backup' : 'text-tertiary'}">${priceDisplay}</span>
                                <i class="fas fa-chevron-right text-gray-500"></i>
                            </div>
                            <p class="text-xs text-primary mt-1">${savings > 0 ? `Save ${savings} Tokens!` : ''}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <!-- Back Button -->
                    <button onclick="navigate('home')" class="text-gray-300 hover:text-primary mb-6 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Home
                    </button>
                    
                    <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                        Special <span class="text-gradient">Offers & Bundles</span>
                    </h2>

                    <!-- Main Promotional Banner -->
                    <div class="card-gradient rounded-xl p-8 mb-8 text-white shadow-2xl bg-gradient-to-br from-secondary to-primary/80">
                        <h3 class="text-3xl font-heading font-bold mb-2">Unlock Unlimited Access!</h3>
                        <p class="text-lg opacity-90">Get the Annual Pro Pack and save 300 tokens!</p>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/30">
                            <p class="text-4xl font-extrabold flex items-center">
                                <i class="fas fa-tags mr-3"></i> 999 Tokens 
                                <s class="text-xl opacity-60 ml-3">1299 T.</s>
                            </p>
                            <button onclick="alertCustom('Pro Pack', 'Annual Pro Pack checkout simulated.')" class="bg-white text-primary px-5 py-2 rounded-full font-bold hover:bg-gray-200 transition">Buy Now</button>
                        </div>
                    </div>

                    <!-- Dynamic Bundle Cards -->
                    <h3 class="text-2xl font-heading font-bold mb-4 mt-10 text-white">Curated Subject Bundles</h3>
                    <div class="grid md:grid-cols-2 gap-6" id="dynamic-offers-container">
                        ${offerCards}
                    </div>
                    ${activeOffers.length === 0 ? '<p class="text-center text-gray-500 mt-6 p-8 card-gradient rounded-xl">No active bundle offers right now. Check back soon!</p>' : ''}
                </div>
            `;
            updateHeaderUI();
        }

        /**
         * Navigates to and renders the Offer Details Page.
         * @param {number} offerId - The ID of the selected offer.
         */
        function showOfferDetails(offerId) {
            const offer = DUMMY_OFFERS.find(o => o.id === offerId);
            if (offer) {
                renderOfferDetails(offer);
                navigate('offer-details');
            } else {
                alertCustom('Error', 'Offer not found.');
            }
        }
        
        /**
         * Renders the Offer Details Page content.
         * @param {object} offer - The offer data object.
         */
        function renderOfferDetails(offer) {
            const pageContainer = document.getElementById('offer-details-page');
            
            const bundledProducts = offer.productIds.map(id => DUMMY_PRODUCTS.find(p => p.id === id)).filter(p => p);
            
            const originalPrice = bundledProducts.reduce((sum, p) => sum + p.price, 0);
            const savings = originalPrice - offer.tokenPrice;
            const priceDisplay = offer.tokenPrice === 0 ? 'FREE' : `${offer.tokenPrice} Tokens`;

            const productListHTML = bundledProducts.map(p => `
                <div class="flex justify-between items-center py-2 border-b border-gray-800">
                    <p class="text-sm text-white font-medium">${p.title}</p>
                    <p class="text-xs text-gray-400">${p.type} | ${p.price} T.</p>
                </div>
            `).join('');

            pageContainer.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <!-- Back Button -->
                    <button onclick="navigate('offers')" class="text-gray-300 hover:text-primary mb-6 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Offers
                    </button>

                    <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                        <span class="text-gradient">${offer.title}</span>
                    </h2>

                    <div class="grid lg:grid-cols-3 gap-8">
                        
                        <!-- Left Column: Summary & Actions -->
                        <div class="lg:col-span-1">
                            <div class="card-gradient rounded-xl p-6 shadow-2xl sticky top-24">
                                <h3 class="text-2xl font-heading font-bold text-white mb-4 border-b border-gray-700/50 pb-3">Bundle Summary</h3>
                                
                                <div class="space-y-2 text-sm mb-6">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Total Products</span>
                                        <span class="font-medium text-white">${bundledProducts.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Total Individual Value</span>
                                        <span class="font-medium text-white">${originalPrice} Tokens</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Discount Applied</span>
                                        <span class="font-medium text-secondary">${offer.discount}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Duration</span>
                                        <span class="font-medium text-white">${offer.duration}</span>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between font-bold text-lg mb-6 pt-3 border-t border-gray-700/50">
                                    <span>Bundle Price</span>
                                    <span class="text-3xl ${offer.tokenPrice === 0 ? 'text-backup' : 'text-tertiary'}">${priceDisplay}</span>
                                </div>

                                <button onclick="purchaseOffer(${offer.id}, ${offer.tokenPrice})" 
                                        class="w-full py-4 rounded-xl btn-primary-gradient text-white text-lg font-bold shadow-2xl hover:scale-[1.02] transition ${offer.status !== 'Active' ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${offer.status !== 'Active' ? 'disabled' : ''}>
                                    <i class="fas fa-shopping-basket mr-2"></i> ${offer.tokenPrice === 0 ? 'Claim Free Bundle' : 'Buy Bundle Now'}
                                </button>
                                ${offer.status !== 'Active' ? `<p class="text-sm mt-3 text-center text-red-400">Offer is currently ${offer.status}.</p>` : ''}
                            </div>
                        </div>

                        <!-- Right Column: Product List -->
                        <div class="lg:col-span-2">
                            <div class="card-gradient rounded-xl p-6 shadow-2xl">
                                <h3 class="text-xl font-heading font-bold text-primary mb-4 border-b border-gray-700/50 pb-3">Included Documents (${bundledProducts.length})</h3>
                                <div class="space-y-1">
                                    ${productListHTML}
                                </div>
                            </div>

                            <p class="text-sm text-gray-500 mt-6">Note: Purchasing the bundle adds all included documents to your library permanently.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Simulates purchasing an entire offer bundle.
         * @param {number} offerId 
         * @param {number} cost 
         */
        function purchaseOffer(offerId, cost) {
            const offer = DUMMY_OFFERS.find(o => o.id === offerId);
            if (!offer || offer.status !== 'Active') {
                alertCustom('Error', 'This offer is not active.');
                return;
            }
            if (cost > userWalletTokens) {
                alertCustom('Error', 'Insufficient tokens for this purchase.');
                return;
            }

            // Simulate transaction
            if (cost > 0) {
                 userWalletTokens -= cost;
                 TRANSACTION_HISTORY.unshift({ 
                    id: Date.now(), 
                    type: 'Debit', 
                    amount: cost, 
                    date: new Date().toISOString().slice(0, 10), 
                    description: `Purchased Bundle: ${offer.title}`
                });
            } else {
                 TRANSACTION_HISTORY.unshift({ 
                    id: Date.now(), 
                    type: 'Download', 
                    amount: 0, 
                    date: new Date().toISOString().slice(0, 10), 
                    description: `Claimed Free Bundle: ${offer.title}`
                });
            }

            // Add all included items to mock bookmarks (library)
            offer.productIds.forEach(id => {
                if (!bookmarkedProductIds.includes(id)) {
                    bookmarkedProductIds.push(id);
                }
            });

            alertCustom('Success', `Bundle "${offer.title}" purchased/claimed successfully!`);
            
            // Navigate back to the offer list
            navigate('offers');
        }


        // ====================================
        // 5.9.5. User Activity Logic
        // ====================================
        
        /**
         * Renders the standard User Activity Page (Purchases/Downloads).
         */
        function renderUserActivityPage() {
            const container = document.getElementById('user-activity-page');
            
            // Filter transactions to only show debits (purchases) and downloads
            const userActivity = TRANSACTION_HISTORY.filter(tx => tx.type === 'Debit' || tx.type === 'Download');
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-heading font-extrabold mb-8 text-white">
                        My <span class="text-gradient">Purchases & Downloads</span>
                    </h2>
                    
                    <div class="space-y-4">
                        <h3 class="text-2xl font-heading font-bold mb-4 text-primary">Recent Activity</h3>
                        ${userActivity.length > 0 ? userActivity.map(tx => {
                            const icon = tx.type === 'Debit' ? 'fas fa-shopping-bag text-secondary' : 'fas fa-download text-backup';
                            const badge = tx.type === 'Debit' ? 'Purchased' : 'Downloaded';
                            const cost = tx.type === 'Debit' ? `${tx.amount} Tokens` : 'Free';
                            
                            return `
                                <div class="card-gradient rounded-xl p-4 flex items-center space-x-4 shadow-lg">
                                    <i class="${icon} text-2xl w-8 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-semibold text-white">${tx.description}</p>
                                        <p class="text-xs text-gray-500">${tx.date}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-sm font-bold ${tx.type === 'Debit' ? 'text-tertiary' : 'text-backup'}">${cost}</span>
                                        <p class="text-xs font-medium text-gray-400 mt-0.5">${badge}</p>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <p class="col-span-full text-center text-gray-400 p-8 card-gradient rounded-xl">
                                You have no purchase or download history yet.
                            </p>
                        `}
                    </div>
                </div>
            `;
        }

        // ====================================
        // 5.10. Admin Page Logic
        // ====================================
        
        let currentAdminSection = 'dashboard';

        /**
         * Toggles the visibility of the admin sidebar (used primarily on mobile).
         */
        function toggleAdminSidebar() {
            const sidebarOverlay = document.getElementById('admin-sidebar-overlay');
            sidebarOverlay.classList.toggle('active');
        }

        /**
         * Updates the active state of the Admin sidebar.
         * @param {string} section - The section ID.
         */
        function updateAdminNav(section) {
            document.querySelectorAll('.admin-nav-item').forEach(btn => {
                btn.classList.remove('active-admin-nav', 'bg-primary/20', 'text-white');
                btn.classList.add('text-gray-300', 'hover:bg-gray-700/50');
                
                if (btn.getAttribute('onclick').includes(`'${section}'`)) {
                    btn.classList.add('active-admin-nav', 'bg-primary/20', 'text-white');
                }
            });
        }

        /**
         * Renders the specified administrative section content.
         * @param {string} section - The section to render (dashboard, products, sales, users, offers).
         */
        function renderAdminSection(section) {
            currentAdminSection = section;
            updateAdminNav(section);
            const contentContainer = document.getElementById('admin-content');
            
            // Close sidebar on mobile after selection
            if (window.innerWidth < 1024) {
                 toggleAdminSidebar();
            }

            // Clear existing content
            contentContainer.innerHTML = ''; 
            
            // Hide specific full-page admin form sections
            document.getElementById('admin-product-form-page').classList.add('hidden');
            document.getElementById('admin-offer-form-page').classList.add('hidden');
            
            // Ensure main dashboard wrapper is visible when viewing lists/dashboards
            document.getElementById('admin-dashboard-page').classList.remove('hidden');


            switch (section) {
                case 'dashboard':
                    renderAdminDashboard();
                    break;
                case 'products':
                    renderAdminProductsList();
                    break;
                case 'sales':
                    renderAdminSalesPage();
                    break;
                case 'users':
                    renderAdminUsersPage();
                    break;
                case 'offers':
                    renderAdminOffersList(); // Changed to List view
                    break;
                default:
                    // Fallback to dashboard
                    renderAdminDashboard();
                    break;
            }
        }

        /**
         * Renders the Admin Dashboard content.
         */
        function renderAdminDashboard() {
            const contentContainer = document.getElementById('admin-content');
             
            contentContainer.innerHTML = `
                <h3 class="text-3xl font-heading font-bold mb-6 text-white">Key Metrics</h3>
                
                <!-- Metric Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                    <!-- Metric 1: Tokens Sold -->
                    <div class="card-gradient rounded-xl p-5 shadow-2xl border-t-4 border-primary">
                        <p class="text-sm text-gray-400">Total Tokens Sold</p>
                        <h4 class="text-3xl font-heading font-extrabold text-primary mt-1">${DUMMY_ADMIN_METRICS.totalTokensSold.toLocaleString()}</h4>
                        <p class="text-xs text-gray-500 mt-2">Revenue goal: 15,000</p>
                    </div>
                    <!-- Metric 2: Downloads -->
                    <div class="card-gradient rounded-xl p-5 shadow-2xl border-t-4 border-backup">
                        <p class="text-sm text-gray-400">Total Downloads</p>
                        <h4 class="text-3xl font-heading font-extrabold text-backup mt-1">${DUMMY_ADMIN_METRICS.totalDownloads.toLocaleString()}</h4>
                        <p class="text-xs text-gray-500 mt-2">Free documents excluded</p>
                    </div>
                    <!-- Metric 3: Active Users -->
                    <div class="card-gradient rounded-xl p-5 shadow-2xl border-t-4 border-tertiary">
                        <p class="text-sm text-gray-400">Active Users</p>
                        <h4 class="text-3xl font-heading font-extrabold text-tertiary mt-1">${DUMMY_ADMIN_METRICS.activeUsers.toLocaleString()}</h4>
                        <p class="text-xs text-gray-500 mt-2">Logged in last 30 days</p>
                    </div>
                        <!-- Metric 4: Product Count -->
                    <div class="card-gradient rounded-xl p-5 shadow-2xl border-t-4 border-secondary">
                        <p class="text-sm text-gray-400">Total Products</p>
                        <h4 class="text-3xl font-heading font-extrabold text-secondary mt-1">${DUMMY_ADMIN_METRICS.productCount}</h4>
                        <p class="text-xs text-gray-500 mt-2">Notes, Books, Journals</p>
                    </div>
                </div>

                <!-- Activity Widgets -->
                <h3 class="text-2xl font-heading font-bold mb-4 mt-6 text-white">Recent Admin Activity</h3>
                <div id="admin-activity-list" class="space-y-3 card-gradient rounded-xl p-4 shadow-xl">
                    ${DUMMY_ADMIN_ACTIVITY.map(activity => `
                        <div class="flex justify-between items-center border-b border-gray-700/50 last:border-b-0 py-2">
                            <div class="flex items-center space-x-3">
                                <i class="fas ${activity.type.includes('Sale') ? 'fa-dollar-sign text-backup' : activity.type.includes('User') ? 'fa-user-plus text-tertiary' : 'fa-info-circle text-primary'} text-sm"></i>
                                <p class="text-sm font-medium text-white">${activity.description}</p>
                            </div>
                            <span class="text-xs text-gray-500">${activity.date}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /**
         * Renders the Product Management list view.
         */
        function renderAdminProductsList() {
            const contentContainer = document.getElementById('admin-content');
            
            contentContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-3xl font-heading font-bold text-white">Product Listing (${DUMMY_PRODUCTS.length})</h3>
                    <button onclick="renderProductForm('add')" class="px-4 py-2 rounded-lg btn-primary-gradient text-white font-semibold shadow-xl">
                        <i class="fas fa-plus mr-2"></i> Add New Product
                    </button>
                </div>

                <!-- Product Table -->
                <div class="overflow-x-auto card-gradient rounded-xl shadow-2xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Price (T)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700/50">
                            ${DUMMY_PRODUCTS.map(p => `
                                <tr class="hover:bg-gray-700/30 transition">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${p.title}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${p.type}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-tertiary font-bold">${p.isFree ? 'FREE' : p.price}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="renderProductForm('edit', ${p.id})" class="text-primary hover:text-secondary mr-3 transition">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteProduct(${p.id}, '${p.title}')" class="text-red-500 hover:text-red-400 transition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * Simulates setting the display file name in the Admin form.
         * @param {string} fileName - The name of the file.
         */
        function setFileNameDisplay(fileName) {
            formDocumentFileName = fileName;
            const nameEl = document.getElementById('document-file-name');
            if (nameEl) {
                nameEl.textContent = fileName;
                nameEl.classList.remove('text-gray-400', 'italic');
                nameEl.classList.add('text-backup', 'font-semibold');
            }
            const dragArea = document.getElementById('drag-drop-area');
            if(dragArea) dragArea.classList.remove('drag-over');
        }

        /**
         * Handles direct file selection from input.
         * @param {Event} event - The file select event.
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                setFileNameDisplay(file.name);
            }
        }
        
        function handleCoverImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('cover-image-preview');
                    if (preview) {
                        preview.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleProfileImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Update all profile images across the app
                    updateAllProfileImages(e.target.result);
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('userProfileImage', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }
        
        /**
         * Updates all profile images across the application
         * @param {string} imageUrl - The URL of the new profile image
         */
        function updateAllProfileImages(imageUrl) {
            // Update profile preview in edit form
            const preview = document.getElementById('profile-image-preview');
            if (preview) preview.src = imageUrl;
            
            // Update header profile image
            const headerImage = document.getElementById('header-profile-image');
            if (headerImage) headerImage.src = imageUrl;
            
            // Update profile page image
            const profilePageImage = document.getElementById('profile-page-image');
            if (profilePageImage) profilePageImage.src = imageUrl;
            
            // Update any other profile images in the app
            document.querySelectorAll('.user-profile-icon').forEach(img => {
                img.src = imageUrl;
            });
        }

        /**
         * Handles drag over event for visual cue.
         * @param {Event} event - The drag event.
         */
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('drag-drop-area').classList.add('drag-over');
        }

        /**
         * Handles drag leave event for visual cue.
         * @param {Event} event - The drag event.
         */
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('drag-drop-area').classList.remove('drag-over');
        }

        /**
         * Handles file drop event.
         * @param {Event} event - The drop event.
         */
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('drag-drop-area').classList.remove('drag-over');
            
            const file = event.dataTransfer.files[0];
            if (file) {
                setFileNameDisplay(file.name);
            }
        }
        
        /**
         * Renders the Add/Edit Product Form.
         * @param {string} mode - 'add' or 'edit'.
         * @param {number | null} id - Product ID if editing.
         */
        function renderProductForm(mode, id = null) {
            // Hide the admin dashboard grid
            document.getElementById('admin-dashboard-page').classList.add('hidden');
            
            const formPage = document.getElementById('admin-product-form-page');
            formPage.classList.remove('hidden');

            const isEdit = mode === 'edit';
            const product = isEdit ? DUMMY_PRODUCTS.find(p => p.id === id) : {};
            const titleText = isEdit ? `Edit Product: ${product.title}` : 'Add New Product';
            const buttonText = isEdit ? 'Save Changes' : 'Create Product';
            
            // Reset mock file name display state or set initial state for edit
            if (isEdit) {
                 formDocumentFileName = product.title ? `${product.title.replace(/\s/g, '_')}_v1.pdf` : 'No file selected (Mock)';
            } else {
                 formDocumentFileName = 'No file selected (Mock)';
            }

            formPage.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-heading font-extrabold mb-8 text-gradient">${titleText}</h2>

                    <form onsubmit="handleProductSave(event, ${id})" class="space-y-6 card-gradient p-8 rounded-xl shadow-2xl">
                        
                        <!-- Title and Description -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="form-title" class="block text-sm font-medium text-gray-400 mb-2">Title</label>
                                <input type="text" id="form-title" value="${product.title || ''}" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                            <div>
                                <label for="form-author" class="block text-sm font-medium text-gray-400 mb-2">Author</label>
                                <input type="text" id="form-author" value="${product.author || 'Tutor Admin'}" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                        </div>

                        <div>
                            <label for="form-description" class="block text-sm font-medium text-gray-400 mb-2">Short Description</label>
                            <textarea id="form-description" rows="2" required
                                      class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">${product.description || ''}</textarea>
                        </div>
                        
                        <!-- Cover Image Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Cover Image</label>
                            <div class="flex items-center space-x-4">
                                <div class="w-32 h-40 bg-gray-800 border border-gray-700 rounded-lg overflow-hidden flex items-center justify-center">
                                    <img id="cover-image-preview" src="${product.coverImage || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%236B7280\'%3E%3Cpath d=\'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-5.04-6.71l-2.75 3.54-1.96-2.36L6.5 17h11l-3.54-4.71z\'/%3E%3C/svg%3E'}" 
                                         alt="Cover preview" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1">
                                    <button type="button" onclick="document.getElementById('form-cover-image').click()" 
                                            class="btn-primary-gradient px-4 py-2 rounded-lg text-sm font-medium">
                                        <i class="fas fa-image mr-2"></i>Choose Cover Image
                                    </button>
                                    <p class="text-xs text-gray-400 mt-2">Recommended size: 400x600px. JPG, PNG or SVG.</p>
                                    <input type="file" id="form-cover-image" accept=".jpg,.jpeg,.png,.svg" class="hidden" 
                                           onchange="handleCoverImageSelect(event)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Document Field (Draggable) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Document File (PDF/MD)</label>
                            <div id="drag-drop-area" 
                                class="drag-area p-6 rounded-lg text-center cursor-pointer"
                                ondragover="handleDragOver(event)"
                                ondragleave="handleDragLeave(event)"
                                ondrop="handleDrop(event)"
                                onclick="document.getElementById('form-document-file').click()">
                                <i class="fas fa-file-upload text-3xl text-primary mb-2"></i>
                                <p class="text-sm text-gray-400">Drag & drop your file here, or click to browse (Mock)</p>
                                <p id="document-file-name" class="text-sm ${formDocumentFileName.includes('Mock') ? 'text-gray-400 italic' : 'text-backup font-semibold'} mt-2">${formDocumentFileName}</p>
                                <input type="file" id="form-document-file" accept=".pdf,.md,.txt" class="hidden" onchange="handleFileSelect(event)">
                            </div>
                        </div>

                        <!-- Type, Price, and Free/Premium -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <label for="form-type" class="block text-sm font-medium text-gray-400 mb-2">Asset Type</label>
                                <select id="form-type" required
                                        class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                                    <option value="Notes" ${product.type === 'Notes' ? 'selected' : ''}>Notes</option>
                                    <option value="Books" ${product.type === 'Books' ? 'selected' : ''}>Book</option>
                                    <option value="Journals" ${product.type === 'Journals' ? 'selected' : ''}>Journal</option>
                                </select>
                            </div>
                            <div>
                                <label for="form-price" class="block text-sm font-medium text-gray-400 mb-2">Price (Tokens)</label>
                                <input type="number" id="form-price" value="${product.price || 0}" min="0" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                            <div class="flex items-end">
                                <label class="relative inline-flex items-center cursor-pointer p-3 card-gradient rounded-xl w-full">
                                    <input type="checkbox" id="form-is-free" ${product.isFree ? 'checked' : ''} class="sr-only peer" onchange="togglePriceField()">
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-backup/50 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-1 after:start-[6px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-backup"></div>
                                    <span class="ms-3 text-sm font-medium text-white">Mark as FREE</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Tags (Simplified input) -->
                        <div>
                            <label for="form-tags" class="block text-sm font-medium text-gray-400 mb-2">Tags (Comma separated, e.g., STEM, Advanced)</label>
                            <input type="text" id="form-tags" value="${product.tags ? product.tags.join(', ') : ''}"
                                   class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                        </div>

                        <!-- Full Details (Long Description) -->
                        <div>
                            <label for="form-details" class="block text-sm font-medium text-gray-400 mb-2">Full Details / Long Description</label>
                            <textarea id="form-details" rows="4" required
                                      class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">${product.details || ''}</textarea>
                        </div>


                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" onclick="renderAdminSection('products')" 
                                    class="px-5 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                                Cancel
                            </button>
                            <button type="submit" class="px-5 py-2 rounded-lg btn-primary-gradient text-white font-semibold shadow-lg">
                                <i class="fas fa-save mr-2"></i> ${buttonText}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }
        
        /**
         * Simulates saving a product entry.
         */
        function handleProductSave(event, id) {
            event.preventDefault();
            
            const isEdit = id !== null && id !== undefined;
            
            const title = document.getElementById('form-title').value;
            const author = document.getElementById('form-author').value;
            const description = document.getElementById('form-description').value;
            const type = document.getElementById('form-type').value;
            const price = parseInt(document.getElementById('form-price').value);
            const isFree = document.getElementById('form-is-free').checked;
            const tagsInput = document.getElementById('form-tags').value;
            const details = document.getElementById('form-details').value;
            
            const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            // Get cover image if available
            const coverImage = document.getElementById('cover-image-preview').src;
            
            const newProductData = {
                type, title, description, price, isFree, author, details, tags,
                coverImage, // Add cover image to product data
                rating: 5.0, // Mock fixed rating for admin creation
                reviewCount: 0,
                // Ensure other fields are retained if editing, or defaulted if new
                content: isEdit ? DUMMY_PRODUCTS.find(p => p.id === id).content : `## New Document: ${title}`,
                // Mock file name capture (simulate upload success)
                uploadedFile: formDocumentFileName 
            };
            
            // Basic check to ensure a document file was selected (if not editing an existing doc)
            if (!isEdit && newProductData.uploadedFile.includes('Mock')) {
                 alertCustom('Validation Error', 'Please select or drag a document file to upload.');
                 return;
            }


            if (isEdit) {
                // Find and update existing product
                const index = Dummy_PRODUCTS.findIndex(p => p.id === id);
                if (index !== -1) {
                    DUMMY_PRODUCTS[index] = { ...DUMMY_PRODUCTS[index], ...newProductData };
                    alertCustom('Update Success', `Product "${title}" updated successfully.`);
                }
            } else {
                // Add new product
                const newId = DUMMY_PRODUCTS.length > 0 ? Math.max(...DUMMY_PRODUCTS.map(p => p.id)) + 1 : 1;
                newProductData.id = newId;
                DUMMY_PRODUCTS.push(newProductData);
                alertCustom('Creation Success', `New product "${title}" created successfully.`);
            }
            
            // Navigate back to the product list and re-render
            DUMMY_ADMIN_METRICS.productCount = DUMMY_PRODUCTS.length;
            renderAdminSection('products');
        }
        
        /**
         * Simulates deleting a product.
         */
        function deleteProduct(id, title) {
            if (confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
                const initialLength = DUMMY_PRODUCTS.length;
                DUMMY_PRODUCTS = DUMMY_PRODUCTS.filter(p => p.id !== id);
                if (DUMMY_PRODUCTS.length < initialLength) {
                    alertCustom('Deletion Success', `Product "${title}" deleted.`);
                    DUMMY_ADMIN_METRICS.productCount = DUMMY_PRODUCTS.length;
                    renderAdminSection('products'); // Re-render list
                }
            }
        }
        
        // ====================================
        // 5.11. Admin Offer Management Logic
        // ====================================
        
        /**
         * Renders the Offer Management list view.
         */
        function renderAdminOffersList() {
            const contentContainer = document.getElementById('admin-content');
            
            contentContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-3xl font-heading font-bold text-white">Offer Management (${DUMMY_OFFERS.length})</h3>
                    <button onclick="renderOfferForm('add')" class="px-4 py-2 rounded-lg btn-primary-gradient text-white font-semibold shadow-xl">
                        <i class="fas fa-plus mr-2"></i> Create New Offer
                    </button>
                </div>

                <!-- Offers Table -->
                <div class="overflow-x-auto card-gradient rounded-xl shadow-2xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Discount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Duration</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700/50">
                            ${DUMMY_OFFERS.map(offer => `
                                <tr class="hover:bg-gray-700/30 transition">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${offer.title}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-tertiary font-bold">${offer.discount}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${offer.duration}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${offer.status === 'Active' ? 'text-backup' : 'text-red-400'}">${offer.status}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="renderOfferForm('edit', ${offer.id})" class="text-primary hover:text-secondary mr-3 transition">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteOffer(${offer.id}, '${offer.title}')" class="text-red-500 hover:text-red-400 transition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        /**
         * Renders the Add/Edit Offer Form.
         * @param {string} mode - 'add' or 'edit'.
         * @param {number | null} id - Offer ID if editing.
         */
        function renderOfferForm(mode, id = null) {
            // Hide the admin dashboard grid
            document.getElementById('admin-dashboard-page').classList.add('hidden');
            
            const formPage = document.getElementById('admin-offer-form-page');
            formPage.classList.remove('hidden');

            const isEdit = mode === 'edit';
            const offer = isEdit ? DUMMY_OFFERS.find(o => o.id === id) : {};
            const titleText = isEdit ? `Edit Offer: ${offer.title}` : 'Create New Offer/Bundle';
            const buttonText = isEdit ? 'Save Offer Changes' : 'Create Offer';
            
            // Generate checkboxes for products to include
            const offerProductIds = isEdit && offer.productIds ? offer.productIds : [];
            const productCheckboxes = DUMMY_PRODUCTS.map(p => {
                const isChecked = offerProductIds.includes(p.id);
                const priceText = p.isFree ? 'Free' : `${p.price} T.`;
                
                return `
                    <label class="flex items-center space-x-2 py-2 px-3 hover:bg-gray-700/50 rounded-lg cursor-pointer transition">
                        <input type="checkbox" name="offer-product" value="${p.id}" ${isChecked ? 'checked' : ''}
                               class="h-4 w-4 text-primary bg-gray-800 border-gray-600 rounded focus:ring-primary/70">
                        <span class="text-sm text-white flex-1">${p.title} <span class="text-xs text-gray-500">(${p.type})</span></span>
                        <span class="ml-auto text-xs font-semibold ${p.isFree ? 'text-backup' : 'text-tertiary'}">${priceText}</span>
                    </label>`;
            }).join('');


            formPage.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-heading font-extrabold mb-8 text-gradient">${titleText}</h2>

                    <form onsubmit="handleOfferSave(event, ${id})" class="space-y-6 card-gradient p-8 rounded-xl shadow-2xl">
                        
                        <!-- Title and Discount -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-2">
                                <label for="offer-title" class="block text-sm font-medium text-gray-400 mb-2">Offer Title/Name</label>
                                <input type="text" id="offer-title" value="${offer.title || ''}" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                            <div>
                                <label for="offer-discount" class="block text-sm font-medium text-gray-400 mb-2">Discount/Value (e.g., 50% / Free Item)</label>
                                <input type="text" id="offer-discount" value="${offer.discount || ''}" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                        </div>

                        <!-- Price, Duration, Status -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <label for="offer-price" class="block text-sm font-medium text-gray-400 mb-2">Token Price</label>
                                <input type="number" id="offer-price" value="${offer.tokenPrice || 0}" min="0" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                            <div>
                                <label for="offer-duration" class="block text-sm font-medium text-gray-400 mb-2">Duration (e.g., 30 Days / Permanent)</label>
                                <input type="text" id="offer-duration" value="${offer.duration || '30 Days'}" required
                                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                            </div>
                            <div>
                                <label for="offer-status" class="block text-sm font-medium text-gray-400 mb-2">Status</label>
                                <select id="offer-status" required
                                        class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-primary focus:border-primary transition">
                                    <option value="Active" ${offer.status === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${offer.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="Expired" ${offer.status === 'Expired' ? 'selected' : ''}>Expired</option>
                                </select>
                            </div>
                        </div>

                        <!-- Products Included (Checkboxes) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Products Included</label>
                            <div id="offer-products-checkboxes" class="p-3 card-gradient rounded-lg border border-gray-700 overflow-y-auto h-48 space-y-1">
                                ${productCheckboxes}
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" onclick="renderAdminSection('offers')" 
                                    class="px-5 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                                Cancel
                            </button>
                            <button type="submit" class="px-5 py-2 rounded-lg btn-primary-gradient text-white font-semibold shadow-lg">
                                <i class="fas fa-save mr-2"></i> ${buttonText}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        /**
         * Simulates saving an offer entry.
         */
        function handleOfferSave(event, id) {
            event.preventDefault();
            
            const isEdit = id !== null && id !== undefined;
            
            const title = document.getElementById('offer-title').value;
            const discount = document.getElementById('offer-discount').value;
            const tokenPrice = parseInt(document.getElementById('offer-price').value);
            const duration = document.getElementById('offer-duration').value;
            const status = document.getElementById('offer-status').value;
            
            // NEW: Get selected product IDs from checkboxes
            const productCheckboxes = document.querySelectorAll('input[name="offer-product"]:checked');
            const selectedProductIds = Array.from(productCheckboxes).map(checkbox => parseInt(checkbox.value));
            
            if (selectedProductIds.length === 0) {
                alertCustom('Validation Error', 'Please select at least one product for the offer.');
                return;
            }

            const newOfferData = {
                title, discount, tokenPrice, duration, status, 
                productIds: selectedProductIds,
            };

            if (isEdit) {
                // Find and update existing offer
                const index = DUMMY_OFFERS.findIndex(o => o.id === id);
                if (index !== -1) {
                    DUMMY_OFFERS[index] = { ...DUMMY_OFFERS[index], ...newOfferData };
                    alertCustom('Update Success', `Offer "${title}" updated successfully.`);
                }
            } else {
                // Add new offer
                const newId = DUMMY_OFFERS.length > 0 ? Math.max(...DUMMY_OFFERS.map(o => o.id)) + 1 : 204;
                newOfferData.id = newId;
                DUMMY_OFFERS.push(newOfferData);
                alertCustom('Creation Success', `New offer "${title}" created successfully.`);
            }
            
            // Navigate back to the offer list and re-render
            renderAdminSection('offers');
        }

        /**
         * Simulates deleting an offer.
         */
        function deleteOffer(id, title) {
            if (confirm(`Are you sure you want to delete offer "${title}"? This action cannot be undone.`)) {
                const initialLength = DUMMY_OFFERS.length;
                DUMMY_OFFERS = DUMMY_OFFERS.filter(o => o.id !== id);
                if (DUMMY_OFFERS.length < initialLength) {
                    alertCustom('Deletion Success', `Offer "${title}" deleted.`);
                    renderAdminSection('offers'); // Re-render list
                }
            }
        }
        
        // Admin Page Placeholders
        function renderAdminSalesPage() {
            const contentContainer = document.getElementById('admin-content');
            contentContainer.innerHTML = `
                <h3 class="text-3xl font-heading font-bold mb-6 text-white">Sales Report & Charts</h3>
                <div class="card-gradient rounded-xl p-8 h-96 flex items-center justify-center text-gray-400">
                    <p class="text-xl">Bar/Line Chart Placeholder for Sales Data</p>
                </div>
            `;
        }
        
        function renderAdminUsersPage() {
            const contentContainer = document.getElementById('admin-content');
            contentContainer.innerHTML = `
                <h3 class="text-3xl font-heading font-bold mb-6 text-white">User Management (${DUMMY_USERS.length})</h3>
                 <div class="overflow-x-auto card-gradient rounded-xl shadow-2xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700/50">
                            ${DUMMY_USERS.map(u => `
                                <tr class="hover:bg-gray-700/30 transition">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${u.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${u.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${u.role === 'Admin' ? 'text-tertiary' : 'text-primary'}">${u.role}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${u.status === 'Active' ? 'text-backup' : 'text-red-400'}">${u.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderAdminOffersPage() {
            // This function is now superseded by renderAdminOffersList
            renderAdminOffersList();
        }

        // ====================================
        // 5.13. Theme Management
        // ====================================
        
        /**
         * Initializes theme based on saved preference or system preference.
         */
        function initializeTheme() {
            const savedTheme = localStorage.getItem('edudoc-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Determine initial theme
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            // Apply theme
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('theme-toggle').checked = true;
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('theme-toggle').checked = false;
            }
        }
        
        /**
         * Toggles between light and dark theme.
         */
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' || !currentTheme ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('edudoc-theme', newTheme);
            
            // Show feedback
            const themeText = newTheme === 'dark' ? 'Dark' : 'Light';
            alertCustom('Theme Changed', `${themeText} theme activated successfully.`);
        }
        
        // ====================================
        // 5.14. Authentication Functions
        // ====================================
        
        let pinCode = '';
        const correctPin = '1234'; // Demo PIN for prototype
        
        function showAuthPage(page) {
            // Hide all auth pages and show app content
            document.getElementById('welcome-page').classList.add('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('signup-page').classList.add('hidden');
            document.getElementById('permissions-page').classList.add('hidden');
            document.getElementById('lock-unlock-page').classList.add('hidden');
            
            // Hide/show header and bottom nav based on auth state
            const header = document.getElementById('floating-header');
            const bottomNav = document.getElementById('bottom-nav');
            const appContainer = document.getElementById('app-container');
            
            if (page === 'none') {
                // Show main app
                header.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                appContainer.classList.remove('hidden');
                document.body.style.paddingBottom = '72px';
            } else {
                // Show auth page
                header.classList.add('hidden');
                bottomNav.classList.add('hidden');
                appContainer.classList.add('hidden');
                document.body.style.paddingBottom = '0';
                
                if (page === 'welcome') document.getElementById('welcome-page').classList.remove('hidden');
                else if (page === 'login') document.getElementById('login-page').classList.remove('hidden');
                else if (page === 'signup') document.getElementById('signup-page').classList.remove('hidden');
                else if (page === 'permissions') document.getElementById('permissions-page').classList.remove('hidden');
                else if (page === 'lock-unlock') document.getElementById('lock-unlock-page').classList.remove('hidden');
            }
        }
        
        function toggleAuthPassword(fieldId, iconId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(iconId);
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }
        
        function simulateBiometricAuth() {
            alert('Biometric authentication simulated. Proceeding...');
            setTimeout(() => {
                showAuthPage('lock-unlock');
            }, 500);
        }
        
        function unlockWithBiometric() {
            setTimeout(() => {
                showAuthPage('none');
            }, 800);
        }
        
        function showPasswordUnlockView() {
            document.getElementById('biometric-view').classList.add('hidden');
            document.getElementById('password-unlock-view').classList.remove('hidden');
        }
        
        function showBiometricUnlockView() {
            document.getElementById('password-unlock-view').classList.add('hidden');
            document.getElementById('biometric-view').classList.remove('hidden');
            clearPin();
        }
        
        function enterPin(digit) {
            if (pinCode.length < 4) {
                pinCode += digit;
                updatePinDisplay();
                
                if (pinCode.length === 4) {
                    verifyPin();
                }
            }
        }
        
        function clearPin() {
            if (pinCode.length > 0) {
                pinCode = pinCode.slice(0, -1);
                updatePinDisplay();
                document.getElementById('error-message').classList.add('hidden');
            }
        }
        
        function updatePinDisplay() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i <= pinCode.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }
        
        function verifyPin() {
            if (pinCode === correctPin) {
                setTimeout(() => {
                    showAuthPage('none');
                }, 500);
            } else {
                document.getElementById('error-message').classList.remove('hidden');
                setTimeout(() => {
                    pinCode = '';
                    updatePinDisplay();
                }, 1000);
            }
        }
        
        // Login form handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('login-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                setTimeout(() => {
                    showAuthPage('lock-unlock');
                }, 500);
            });
            
            // Signup form handler
            document.getElementById('signup-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                if (password !== confirmPassword) {
                    alert('Passwords do not match!');
                    return;
                }
                
                setTimeout(() => {
                    showAuthPage('permissions');
                }, 500);
            });
        });
        
        // ====================================
        // 5.15. Initialization
        // ====================================
        function initializeApp() {
            // Initial setup for Home Page Filters
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', (e) => applyFilter(e.target.getAttribute('data-filter')));
            });

            // Start carousel
            updateCarousel();
            startAutoScroll();
            
            // Initialize theme
            initializeTheme();
            
            // Load saved profile image if exists
            const savedProfileImage = localStorage.getItem('userProfileImage');
            if (savedProfileImage) {
                // Update all profile images across the app
                updateAllProfileImages(savedProfileImage);
            }
            
            // OPTION: Show welcome page on first load (uncomment to enable)
            // Check if user has visited before
            // const hasVisited = localStorage.getItem('edudoc-visited');
            // if (!hasVisited) {
            //     showAuthPage('welcome');
            //     localStorage.setItem('edudoc-visited', 'true');
            //     return;
            // }
            
            // Uncomment the line below to ALWAYS show welcome page on load:
            // showAuthPage('welcome');
            
            // Set initial navigation state to Home and update all UI elements
            navigate('home'); 
            updateHeaderUI();
        }
        
        // Toggle price field based on FREE checkbox
        function togglePriceField() {
            const isFree = document.getElementById('form-is-free').checked;
            const priceField = document.getElementById('form-price');
            
            if (isFree) {
                priceField.value = 0;
                priceField.disabled = true;
            } else {
                priceField.disabled = false;
            }
        }
        
        /**
         * Toggles the audio controls drawer visibility
         */
        function toggleAudioControls() {
            const drawer = document.getElementById('audio-controls-drawer');
            if (drawer.classList.contains('translate-y-full')) {
                // Open drawer
                drawer.classList.remove('translate-y-full');
                drawer.classList.add('translate-y-0');
            } else {
                // Close drawer
                drawer.classList.remove('translate-y-0');
                drawer.classList.add('translate-y-full');
            }
        }
        
        /**
         * Opens the purchase confirmation modal
         * @param {number} productId - The ID of the product to purchase
         */
        function confirmPurchase(productId) {
            const product = DUMMY_PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            // Set modal text
            const confirmText = document.getElementById('purchase-confirm-text');
            confirmText.textContent = `Are you sure you want to purchase "${product.title}" for ${product.price} tokens?`;
            
            // Set confirm button action
            const confirmBtn = document.getElementById('confirm-purchase-btn');
            confirmBtn.onclick = () => {
                processPurchase(productId);
                closePurchaseConfirmModal();
            };
            
            // Show modal
            const modal = document.getElementById('purchase-confirm-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }
        
        /**
         * Closes the purchase confirmation modal
         */
        function closePurchaseConfirmModal() {
            const modal = document.getElementById('purchase-confirm-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
        }
        
        /**
         * Processes the purchase and updates UI
         * @param {number} productId - The ID of the product to purchase
         */
        function processPurchase(productId) {
            const product = DUMMY_PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            // Check if user has enough tokens
            const currentTokens = parseInt(document.getElementById('token-balance').textContent);
            if (currentTokens < product.price) {
                alertCustom('Insufficient Tokens', 'You do not have enough tokens to purchase this item.');
                return;
            }
            
            // Deduct tokens
            const newBalance = currentTokens - product.price;
            document.getElementById('token-balance').textContent = newBalance;
            document.getElementById('wallet-balance-display').textContent = newBalance;
            
            // Add to bookmarks (simulating ownership)
            if (!bookmarkedProductIds.includes(product.id)) {
                bookmarkedProductIds.push(product.id);
                localStorage.setItem('bookmarkedProductIds', JSON.stringify(bookmarkedProductIds));
            }
            
            // Add to transaction history
            DUMMY_TRANSACTIONS.unshift({
                id: Date.now(),
                type: 'Debit',
                amount: product.price,
                date: new Date().toISOString().split('T')[0],
                description: `Purchased ${product.title}`
            });
            
            // Show success message
            alertCustom('Purchase Successful', `You have successfully purchased "${product.title}".`);
            
            // Update product details page to show Read button instead of Purchase
            renderProductDetails(product);
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
